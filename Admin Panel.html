<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KILL STREAK Admin Panel</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <style>
        body {
            background-color: #1f2937;
            color: #f3f4f6;
            font-family: ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
        }
        .sidebar {
            width: 250px;
            background-color: #111827;
            min-height: 100vh;
            position: fixed;
            padding-top: 20px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.2);
        }
        .content {
            margin-left: 250px;
            padding: 20px;
            flex-grow: 1;
        }
        .nav-link {
            display: block;
            padding: 12px 20px;
            color: #d1d5db;
            text-decoration: none;
            transition: background-color 0.3s, color 0.3s;
            font-weight: 500;
            display: flex;
            align-items: center;
        }
        .nav-link i {
            margin-right: 10px;
        }
        .nav-link:hover, .nav-link.active {
            background-color: #374151;
            color: #f97316;
        }
        .card {
            background-color: #374151;
            border-radius: 0.75rem; /* rounded-xl */
            padding: 1.5rem; /* p-6 */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1); /* shadow-lg */
            border: 1px solid #f97316; /* border border-orange-500 */
        }
        .table-header th {
            padding: 0.75rem;
            text-align: left;
            background-color: #1f2937;
            color: #f97316;
            font-weight: 700;
            border-bottom: 2px solid #f97316;
        }
        .table-row td {
            padding: 0.75rem;
            border-bottom: 1px solid #4b5563;
        }
        .table-row:last-child td {
            border-bottom: none;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #1f2937;
            margin: auto;
            padding: 2rem;
            border: 1px solid #f97316;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 600px;
            position: relative;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        }
        .close-button {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-button:hover, .close-button:focus {
            color: white;
        }
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #d1d5db;
            font-weight: 500;
        }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.375rem;
            border: 1px solid #4b5563;
            background-color: #374151;
            color: #f3f4f6;
            box-sizing: border-box; /* Ensure padding doesn't increase width */
        }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: #f97316;
            box-shadow: 0 0 0 2px rgba(249, 115, 22, 0.5);
        }
    </style>
</head>
<body>
    <!-- Admin Login Modal -->
    <div id="adminLoginModal" class="modal">
        <div class="modal-content">
            <h2 class="text-2xl font-bold text-center mb-6 text-orange-400">Admin Login</h2>
            <form id="adminLoginForm">
                <div class="form-group">
                    <label for="adminEmail">Email:</label>
                    <input type="email" id="adminEmail" placeholder="Enter admin email" required>
                </div>
                <div class="form-group">
                    <label for="adminPassword">Password:</label>
                    <input type="password" id="adminPassword" placeholder="Enter admin password" required>
                </div>
                <button type="submit" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-8 rounded-md transition duration-300 w-full mt-4">Login</button>
            </form>
        </div>
    </div>

    <div id="adminPanelContent" class="hidden flex">
        <!-- Sidebar -->
        <div class="sidebar">
            <h1 class="text-3xl font-bold text-center text-orange-500 mb-8">Admin Panel</h1>
            <nav>
                <a href="#" class="nav-link active" data-section="dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
                <a href="#" class="nav-link" data-section="users"><i class="fas fa-users"></i> User Management</a>
                <a href="#" class="nav-link" data-section="tournaments"><i class="fas fa-trophy"></i> Tournament Management</a>
                <a href="#" class="nav-link" data-section="deposits"><i class="fas fa-wallet"></i> Deposit Requests</a>
                <a href="#" class="nav-link" data-section="withdrawals"><i class="fas fa-money-bill-wave"></i> Withdrawal Requests</a>
                <a href="#" class="nav-link" data-section="updates"><i class="fas fa-bullhorn"></i> Admin Updates</a>
                <a href="#" class="nav-link" data-section="upcoming-updates"><i class="fas fa-calendar-alt"></i> Upcoming Updates</a>
                <a href="#" class="nav-link" id="adminLogoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="content flex-1">
            <!-- Dashboard Section -->
            <section id="dashboard" class="admin-section">
                <h2 class="text-3xl font-bold mb-6 text-orange-400">Dashboard</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="card">
                        <h3 class="text-xl font-semibold mb-2">Total Users</h3>
                        <p class="text-4xl font-bold text-orange-500" id="totalUsers">0</p>
                    </div>
                    <div class="card">
                        <h3 class="text-xl font-semibold mb-2">Total Tournaments</h3>
                        <p class="text-4xl font-bold text-orange-500" id="totalTournaments">0</p>
                    </div>
                    <div class="card">
                        <h3 class="text-xl font-semibold mb-2">Pending Deposits</h3>
                        <p class="text-4xl font-bold text-orange-500" id="pendingDeposits">0</p>
                    </div>
                    <div class="card">
                        <h3 class="text-xl font-semibold mb-2">Pending Withdrawals</h3>
                        <p class="text-4xl font-bold text-orange-500" id="pendingWithdrawals">0</p>
                    </div>
                </div>
            </section>

            <!-- User Management Section -->
            <section id="users" class="admin-section hidden">
                <h2 class="text-3xl font-bold mb-6 text-orange-400">User Management</h2>
                <div class="card overflow-x-auto">
                    <table class="min-w-full">
                        <thead>
                            <tr class="table-header">
                                <th>Name</th>
                                <th>Email</th>
                                <th>Wallet Balance</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <!-- User rows will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Tournament Management Section -->
            <section id="tournaments" class="admin-section hidden">
                <h2 class="text-3xl font-bold mb-6 text-orange-400">Tournament Management</h2>
                <button id="addTournamentBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md mb-4">Add New Tournament</button>
                <div class="card overflow-x-auto">
                    <table class="min-w-full">
                        <thead>
                            <tr class="table-header">
                                <th>Name</th>
                                <th>Mode</th>
                                <th>Entry Fee</th>
                                <th>Prize Pool</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tournamentsTableBody">
                            <!-- Tournament rows will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Deposit Requests Section -->
            <section id="deposits" class="admin-section hidden">
                <h2 class="text-3xl font-bold mb-6 text-orange-400">Deposit Requests</h2>
                <div class="card overflow-x-auto">
                    <table class="min-w-full">
                        <thead>
                            <tr class="table-header">
                                <th>User</th>
                                <th>Amount</th>
                                <th>UPI ID</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="depositsTableBody">
                            <!-- Deposit request rows will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Withdrawal Requests Section -->
            <section id="withdrawals" class="admin-section hidden">
                <h2 class="text-3xl font-bold mb-6 text-orange-400">Withdrawal Requests</h2>
                <div class="card overflow-x-auto">
                    <table class="min-w-full">
                        <thead>
                            <tr class="table-header">
                                <th>User</th>
                                <th>Amount</th>
                                <th>UPI ID</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="withdrawalsTableBody">
                            <!-- Withdrawal request rows will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Admin Updates Section -->
            <section id="updates" class="admin-section hidden">
                <h2 class="text-3xl font-bold mb-6 text-orange-400">Admin Updates</h2>
                <button id="addUpdateBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md mb-4">Add New Update</button>
                <div class="card">
                    <ul id="updatesList" class="space-y-4">
                        <!-- Updates will be loaded here -->
                    </ul>
                </div>
            </section>

            <!-- Upcoming Updates Section -->
            <section id="upcoming-updates" class="admin-section hidden">
                <h2 class="text-3xl font-bold mb-6 text-orange-400">Upcoming Tournament Updates</h2>
                <button id="addUpcomingUpdateBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md mb-4">Add New Upcoming Update</button>
                <div class="card">
                    <ul id="upcomingUpdatesList" class="space-y-4">
                        <!-- Upcoming updates will be loaded here -->
                    </ul>
                </div>
            </section>
        </div>
    </div>

    <!-- Modals for Add/Edit Tournament, Add Update -->
    <!-- Add/Edit Tournament Modal -->
    <div id="tournamentModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('tournamentModal')">×</span>
            <h2 class="text-2xl font-bold text-center mb-6 text-orange-400" id="tournamentModalTitle">Add New Tournament</h2>
            <form id="tournamentForm">
                <input type="hidden" id="tournamentId">
                <div class="form-group">
                    <label for="tournamentName">Tournament Name:</label>
                    <input type="text" id="tournamentName" required>
                </div>
                <div class="form-group">
                    <label for="tournamentMode">Mode:</label>
                    <select id="tournamentMode" required>
                        <option value="solo">Solo</option>
                        <option value="duo">Duo</option>
                        <option value="squads">Squads</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="tournamentEntryFee">Entry Fee (₹):</label>
                    <input type="number" id="tournamentEntryFee" required>
                </div>
                <div class="form-group">
                    <label for="tournamentPrizePool">Prize Pool (₹):</label>
                    <input type="number" id="tournamentPrizePool" required>
                </div>
                <div class="form-group">
                    <label for="tournamentDate">Date:</label>
                    <input type="date" id="tournamentDate" required>
                </div>
                <div class="form-group">
                    <label for="tournamentTime">Time:</label>
                    <input type="time" id="tournamentTime" required>
                </div>
                <button type="submit" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-8 rounded-md transition duration-300 w-full mt-4">Save Tournament</button>
            </form>
        </div>
    </div>

    <!-- Add/Edit Update Modal -->
    <div id="updateModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('updateModal')">×</span>
            <h2 class="text-2xl font-bold text-center mb-6 text-orange-400" id="updateModalTitle">Add New Update</h2>
            <form id="updateForm">
                <input type="hidden" id="updateId">
                <div class="form-group">
                    <label for="updateContent">Update Content:</label>
                    <textarea id="updateContent" rows="4" required></textarea>
                </div>
                <button type="submit" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-8 rounded-md transition duration-300 w-full mt-4">Save Update</button>
            </form>
        </div>
    </div>

    <!-- Add/Edit Upcoming Update Modal -->
    <div id="upcomingUpdateModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('upcomingUpdateModal')">×</span>
            <h2 class="text-2xl font-bold text-center mb-6 text-orange-400" id="upcomingUpdateModalTitle">Add New Upcoming Update</h2>
            <form id="upcomingUpdateForm">
                <input type="hidden" id="upcomingUpdateId">
                <div class="form-group">
                    <label for="upcomingUpdateContent">Upcoming Update Content:</label>
                    <textarea id="upcomingUpdateContent" rows="4" required></textarea>
                </div>
                <button type="submit" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-8 rounded-md transition duration-300 w-full mt-4">Save Upcoming Update</button>
            </form>
        </div>
    </div>

    <script>
        // Firebase Configuration - REPLACE THIS WITH YOUR ACTUAL FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: 'AIzaSyBwxgVlQ7dfi5nDLzWWSNWkQ2kam-M5wVs',
            authDomain: 'kill-streak-tournament-50303.firebaseapp.com',
            projectId: 'kill-streak-tournament-50303',
            storageBucket: 'kill-streak-tournament-50303.firebasestorage.app',
            messagingSenderId: '253309521755',
            appId: '1:253309521755:web:7799f296f0de38d84ed47e',
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        const adminLoginModal = document.getElementById('adminLoginModal');
        const adminLoginForm = document.getElementById('adminLoginForm');
        const adminPanelContent = document.getElementById('adminPanelContent');
        const adminLogoutBtn = document.getElementById('adminLogoutBtn');

        const totalUsersSpan = document.getElementById('totalUsers');
        const totalTournamentsSpan = document.getElementById('totalTournaments');
        const pendingDepositsSpan = document.getElementById('pendingDeposits');
        const pendingWithdrawalsSpan = document.getElementById('pendingWithdrawals');

        const usersTableBody = document.getElementById('usersTableBody');
        const tournamentsTableBody = document.getElementById('tournamentsTableBody');
        const depositsTableBody = document.getElementById('depositsTableBody');
        const withdrawalsTableBody = document.getElementById('withdrawalsTableBody');
        const updatesList = document.getElementById('updatesList');
        const upcomingUpdatesList = document.getElementById('upcomingUpdatesList');

        const addTournamentBtn = document.getElementById('addTournamentBtn');
        const tournamentModal = document.getElementById('tournamentModal');
        const tournamentModalTitle = document.getElementById('tournamentModalTitle');
        const tournamentForm = document.getElementById('tournamentForm');

        const addUpdateBtn = document.getElementById('addUpdateBtn');
        const updateModal = document.getElementById('updateModal');
        const updateModalTitle = document.getElementById('updateModalTitle');
        const updateForm = document.getElementById('updateForm');

        const addUpcomingUpdateBtn = document.getElementById('addUpcomingUpdateBtn');
        const upcomingUpdateModal = document.getElementById('upcomingUpdateModal');
        const upcomingUpdateModalTitle = document.getElementById('upcomingUpdateModalTitle');
        const upcomingUpdateForm = document.getElementById('upcomingUpdateForm');

        let currentAdminUser = null;

        // --- Admin Authentication ---
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                // Check if the logged-in user is an admin
                const adminDoc = await db.collection('admin_users').doc(user.uid).get();
                if (adminDoc.exists) {
                    currentAdminUser = user;
                    adminLoginModal.style.display = 'none';
                    adminPanelContent.classList.remove('hidden');
                    loadDashboardData();
                    loadUsers();
                    loadTournaments();
                    loadDepositRequests();
                    loadWithdrawalRequests();
                    loadAdminUpdates();
                    loadUpcomingUpdates();
                } else {
                    // Not an admin, log them out
                    await auth.signOut();
                    adminLoginModal.style.display = 'flex';
                    adminPanelContent.classList.add('hidden');
                    alert('Access Denied: You are not an authorized administrator.');
                }
            } else {
                currentAdminUser = null;
                adminLoginModal.style.display = 'flex';
                adminPanelContent.classList.add('hidden');
            }
        });

        adminLoginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;

            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                alert(`Login failed: ${error.message}`);
            }
        });

        adminLogoutBtn.addEventListener('click', async () => {
            try {
                await auth.signOut();
            } catch (error) {
                console.error('Logout error:', error);
            }
        });

        // --- Navigation ---
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                document.querySelectorAll('.nav-link').forEach(nav => nav.classList.remove('active'));
                link.classList.add('active');

                document.querySelectorAll('.admin-section').forEach(section => section.classList.add('hidden'));
                const targetSection = document.getElementById(link.dataset.section);
                if (targetSection) {
                    targetSection.classList.remove('hidden');
                }
            });
        });

        // --- Dashboard Data Loading ---
        async function loadDashboardData() {
            // Total Users
            const usersSnapshot = await db.collection('users').get();
            totalUsersSpan.innerText = usersSnapshot.size;

            // Total Tournaments
            const tournamentsSnapshot = await db.collection('tournaments').get();
            totalTournamentsSpan.innerText = tournamentsSnapshot.size;

            // Pending Deposits
            const pendingDepositsSnapshot = await db.collection('deposits').where('status', '==', 'pending').get();
            pendingDepositsSpan.innerText = pendingDepositsSnapshot.size;

            // Pending Withdrawals
            const pendingWithdrawalsSnapshot = await db.collection('withdrawals').where('status', '==', 'pending').get();
            pendingWithdrawalsSpan.innerText = pendingWithdrawalsSnapshot.size;
        }

        // --- User Management ---
        async function loadUsers() {
            usersTableBody.innerHTML = '';
            const usersSnapshot = await db.collection('users').get();
            usersSnapshot.forEach(doc => {
                const user = doc.data();
                const row = `
                    <tr class="table-row">
                        <td>${user.name || 'N/A'}</td>
                        <td>${user.email || 'N/A'}</td>
                        <td>₹${(user.walletBalance || 0).toFixed(2)}</td>
                        <td>
                            <button onclick="viewUser('${doc.id}')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-md text-sm mr-2">View</button>
                            <button onclick="deleteUser('${doc.id}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-md text-sm">Delete</button>
                        </td>
                    </tr>
                `;
                usersTableBody.innerHTML += row;
            });
        }

        async function viewUser(userId) {
            const userDoc = await db.collection('users').doc(userId).get();
            const user = userDoc.data();
            const registeredTournamentsSnapshot = await db.collection('registrations').where('userId', '==', userId).get();
            let tournamentsHtml = '';
            registeredTournamentsSnapshot.forEach(regDoc => {
                const reg = regDoc.data();
                const timestamp = reg.timestamp ? new Date(reg.timestamp.toDate()).toLocaleString() : 'N/A';
                tournamentsHtml += `
                    <li class="mb-2">
                        <strong>Mode:</strong> ${reg.mode}<br>
                        <strong>Player 1:</strong> ${reg.player1.name} (UID: ${reg.player1.uid})<br>
                        ${reg.player2 ? `<strong>Player 2:</strong> ${reg.player2.name} (UID: ${reg.player2.uid})<br>` : ''}
                        ${reg.player3 ? `<strong>Player 3:</strong> ${reg.player3.name} (UID: ${reg.player3.uid})<br>` : ''}
                        ${reg.player4 ? `<strong>Player 4:</strong> ${reg.player4.name} (UID: ${reg.player4.uid})<br>` : ''}
                        <em>Registered on: ${timestamp}</em>
                    </li>
                `;
            });

            alert(`
                User Details:
                Name: ${user.name || 'N/A'}
                Email: ${user.email || 'N/A'}
                Mobile: ${user.mobile || 'N/A'}
                Wallet Balance: ₹${(user.walletBalance || 0).toFixed(2)}

                Registered Tournaments:
                ${tournamentsHtml || 'No registered tournaments.'}
            `);
        }

        async function deleteUser(userId) {
            if (confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                try {
                    // Delete user's registrations
                    const registrationsSnapshot = await db.collection('registrations').where('userId', '==', userId).get();
                    const batch = db.batch();
                    registrationsSnapshot.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();

                    // Delete user's wallet transactions (deposits/withdrawals)
                    // Note: This only deletes the request documents, not the actual wallet balance changes.
                    // Wallet balance changes are handled by approve/reject functions.
                    const depositsSnapshot = await db.collection('deposits').where('userId', '==', userId).get();
                    depositsSnapshot.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    const withdrawalsSnapshot = await db.collection('withdrawals').where('userId', '==', userId).get();
                    withdrawalsSnapshot.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();

                    // Delete user document
                    await db.collection('users').doc(userId).delete();

                    // Optionally, delete user from Firebase Authentication (requires Admin SDK on backend)
                    // For simplicity, we're not doing this directly from client-side JS.

                    alert('User deleted successfully!');
                    loadUsers();
                    loadDashboardData();
                } catch (error) {
                    console.error('Error deleting user:', error);
                    alert('Failed to delete user: ' + error.message);
                }
            }
        }

        // --- Tournament Management ---
        async function loadTournaments() {
            tournamentsTableBody.innerHTML = '';
            const tournamentsSnapshot = await db.collection('tournaments').get();
            tournamentsSnapshot.forEach(doc => {
                const tournament = doc.data();
                const row = `
                    <tr class="table-row">
                        <td>${tournament.name}</td>
                        <td>${tournament.mode}</td>
                        <td>₹${tournament.entryFee.toFixed(2)}</td>
                        <td>₹${tournament.prizePool.toFixed(2)}</td>
                        <td>${tournament.date} ${tournament.time}</td>
                        <td>
                            <button onclick="editTournament('${doc.id}')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-md text-sm mr-2">Edit</button>
                            <button onclick="deleteTournament('${doc.id}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-md text-sm">Delete</button>
                        </td>
                    </tr>
                `;
                tournamentsTableBody.innerHTML += row;
            });
        }

        addTournamentBtn.addEventListener('click', () => {
            tournamentModalTitle.innerText = 'Add New Tournament';
            tournamentForm.reset();
            document.getElementById('tournamentId').value = '';
            tournamentModal.style.display = 'flex';
        });

        tournamentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('tournamentId').value;
            const name = document.getElementById('tournamentName').value;
            const mode = document.getElementById('tournamentMode').value;
            const entryFee = parseFloat(document.getElementById('tournamentEntryFee').value);
            const prizePool = parseFloat(document.getElementById('tournamentPrizePool').value);
            const date = document.getElementById('tournamentDate').value;
            const time = document.getElementById('tournamentTime').value;

            const tournamentData = {
                name, mode, entryFee, prizePool, date, time,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                if (id) {
                    await db.collection('tournaments').doc(id).update(tournamentData);
                    alert('Tournament updated successfully!');
                } else {
                    await db.collection('tournaments').add(tournamentData);
                    alert('Tournament added successfully!');
                }
                closeModal('tournamentModal');
                loadTournaments();
                loadDashboardData();
            } catch (error) {
                console.error('Error saving tournament:', error);
                alert('Failed to save tournament: ' + error.message);
            }
        });

        async function editTournament(id) {
            const doc = await db.collection('tournaments').doc(id).get();
            const tournament = doc.data();
            tournamentModalTitle.innerText = 'Edit Tournament';
            document.getElementById('tournamentId').value = id;
            document.getElementById('tournamentName').value = tournament.name;
            document.getElementById('tournamentMode').value = tournament.mode;
            document.getElementById('tournamentEntryFee').value = tournament.entryFee;
            document.getElementById('tournamentPrizePool').value = tournament.prizePool;
            document.getElementById('tournamentDate').value = tournament.date;
            document.getElementById('tournamentTime').value = tournament.time;
            tournamentModal.style.display = 'flex';
        }

        async function deleteTournament(id) {
            if (confirm('Are you sure you want to delete this tournament?')) {
                try {
                    await db.collection('tournaments').doc(id).delete();
                    alert('Tournament deleted successfully!');
                    loadTournaments();
                    loadDashboardData();
                } catch (error) {
                    console.error('Error deleting tournament:', error);
                    alert('Failed to delete tournament: ' + error.message);
                }
            }
        }

        // --- Deposit Requests ---
        async function loadDepositRequests() {
            depositsTableBody.innerHTML = '';
            const depositsSnapshot = await db.collection('deposits').orderBy('timestamp', 'desc').get();
            depositsSnapshot.forEach(doc => {
                const deposit = doc.data();
                const date = deposit.timestamp ? new Date(deposit.timestamp.toDate()).toLocaleString() : 'N/A';
                const statusColor = deposit.status === 'pending' ? 'text-yellow-500' : (deposit.status === 'approved' ? 'text-green-500' : 'text-red-500');
                const row = `
                    <tr class="table-row">
                        <td>${deposit.userName || deposit.userEmail}</td>
                        <td>₹${deposit.amount.toFixed(2)}</td>
                        <td>${deposit.upiTransactionId}</td>
                        <td class="${statusColor}">${deposit.status.toUpperCase()}</td>
                        <td>${date}</td>
                        <td>
                            ${deposit.status === 'pending' ? `
                                <button onclick="approveDeposit('${doc.id}', '${deposit.userId}', ${deposit.amount})" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded-md text-sm mr-2">Approve</button>
                                <button onclick="rejectDeposit('${doc.id}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-md text-sm">Reject</button>
                            ` : ''}
                        </td>
                    </tr>
                `;
                depositsTableBody.innerHTML += row;
            });
        }

        async function approveDeposit(depositId, userId, amount) {
            if (confirm('Are you sure you want to approve this deposit?')) {
                try {
                    // Update deposit status
                    await db.collection('deposits').doc(depositId).update({ status: 'approved' });

                    // Update user's wallet balance using a transaction for safety
                    const userRef = db.collection('users').doc(userId);
                    await db.runTransaction(async (transaction) => {
                        const userDoc = await transaction.get(userRef);
                        if (!userDoc.exists) {
                            throw "User does not exist!";
                        }
                        const newBalance = (userDoc.data().walletBalance || 0) + amount;
                        transaction.update(userRef, { walletBalance: newBalance });
                    });

                    alert('Deposit approved and wallet updated!');
                    loadDepositRequests();
                    loadDashboardData();
                } catch (error) {
                    console.error('Error approving deposit:', error);
                    alert('Failed to approve deposit: ' + error.message);
                }
            }
        }

        async function rejectDeposit(depositId) {
            if (confirm('Are you sure you want to reject this deposit?')) {
                try {
                    await db.collection('deposits').doc(depositId).update({ status: 'rejected' });
                    alert('Deposit rejected!');
                    loadDepositRequests();
                    loadDashboardData();
                } catch (error) {
                    console.error('Error rejecting deposit:', error);
                    alert('Failed to reject deposit: ' + error.message);
                }
            }
        }

        // --- Withdrawal Requests ---
        async function loadWithdrawalRequests() {
            withdrawalsTableBody.innerHTML = '';
            const withdrawalsSnapshot = await db.collection('withdrawals').orderBy('timestamp', 'desc').get();
            withdrawalsSnapshot.forEach(doc => {
                const withdrawal = doc.data();
                const date = withdrawal.timestamp ? new Date(withdrawal.timestamp.toDate()).toLocaleString() : 'N/A';
                const statusColor = withdrawal.status === 'pending' ? 'text-yellow-500' : (withdrawal.status === 'approved' ? 'text-green-500' : 'text-red-500');
                const row = `
                    <tr class="table-row">
                        <td>${withdrawal.userName || withdrawal.userEmail}</td>
                        <td>₹${withdrawal.amount.toFixed(2)}</td>
                        <td>${withdrawal.upiId}</td>
                        <td class="${statusColor}">${withdrawal.status.toUpperCase()}</td>
                        <td>${date}</td>
                        <td>
                            ${withdrawal.status === 'pending' ? `
                                <button onclick="approveWithdrawal('${doc.id}', '${withdrawal.userId}', ${withdrawal.amount})" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded-md text-sm mr-2">Approve</button>
                                <button onclick="rejectWithdrawal('${doc.id}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-md text-sm">Reject</button>
                            ` : ''}
                        </td>
                    </tr>
                `;
                withdrawalsTableBody.innerHTML += row;
            });
        }

        async function approveWithdrawal(withdrawalId, userId, amount) {
            if (confirm('Are you sure you want to approve this withdrawal?')) {
                try {
                    // Update withdrawal status
                    await db.collection('withdrawals').doc(withdrawalId).update({ status: 'approved' });

                    // Deduct from user's wallet balance using a transaction for safety
                    const userRef = db.collection('users').doc(userId);
                    await db.runTransaction(async (transaction) => {
                        const userDoc = await transaction.get(userRef);
                        if (!userDoc.exists) {
                            throw "User does not exist!";
                        }
                        const currentBalance = userDoc.data().walletBalance || 0;
                        if (currentBalance < amount) {
                            // This case should ideally not happen if user-side checks are robust,
                            // but it's good to have a server-side check.
                            throw "Insufficient balance for withdrawal!";
                        }
                        const newBalance = currentBalance - amount;
                        transaction.update(userRef, { walletBalance: newBalance });
                    });

                    alert('Withdrawal approved and wallet updated!');
                    loadWithdrawalRequests();
                    loadDashboardData();
                } catch (error) {
                    console.error('Error approving withdrawal:', error);
                    alert('Failed to approve withdrawal: ' + error.message);
                }
            }
        }

        async function rejectWithdrawal(withdrawalId) {
            if (confirm('Are you sure you want to reject this withdrawal?')) {
                try {
                    await db.collection('withdrawals').doc(withdrawalId).update({ status: 'rejected' });
                    alert('Withdrawal rejected!');
                    loadWithdrawalRequests();
                    loadDashboardData();
                } catch (error) {
                    console.error('Error rejecting withdrawal:', error);
                    alert('Failed to reject withdrawal: ' + error.message);
                }
            }
        }

        // --- Admin Updates ---
        async function loadAdminUpdates() {
            updatesList.innerHTML = '';
            const updatesSnapshot = await db.collection('updates').orderBy('timestamp', 'desc').get();
            updatesSnapshot.forEach(doc => {
                const update = doc.data();
                const date = update.timestamp ? new Date(update.timestamp.toDate()).toLocaleString() : 'N/A';
                const li = `
                    <li class="card flex justify-between items-center">
                        <div>
                            <p class="text-orange-400 font-bold mb-1">Update:</p>
                            <p class="text-sm text-gray-400 mb-2">${date}</p>
                            <p>${update.content}</p>
                        </div>
                        <div>
                            <button onclick="editUpdate('${doc.id}')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-md text-sm mr-2">Edit</button>
                            <button onclick="deleteUpdate('${doc.id}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-md text-sm">Delete</button>
                        </div>
                    </li>
                `;
                updatesList.innerHTML += li;
            });
        }

        addUpdateBtn.addEventListener('click', () => {
            updateModalTitle.innerText = 'Add New Update';
            updateForm.reset();
            document.getElementById('updateId').value = '';
            updateModal.style.display = 'flex';
        });

        updateForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('updateId').value;
            const content = document.getElementById('updateContent').value;

            const updateData = {
                content,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                if (id) {
                    await db.collection('updates').doc(id).update(updateData);
                    alert('Update updated successfully!');
                } else {
                    await db.collection('updates').add(updateData);
                    alert('Update added successfully!');
                }
                closeModal('updateModal');
                loadAdminUpdates();
            } catch (error) {
                console.error('Error saving update:', error);
                alert('Failed to save update: ' + error.message);
            }
        });

        async function editUpdate(id) {
            const doc = await db.collection('updates').doc(id).get();
            const update = doc.data();
            updateModalTitle.innerText = 'Edit Update';
            document.getElementById('updateId').value = id;
            document.getElementById('updateContent').value = update.content;
            updateModal.style.display = 'flex';
        }

        async function deleteUpdate(id) {
            if (confirm('Are you sure you want to delete this update?')) {
                try {
                    await db.collection('updates').doc(id).delete();
                    alert('Update deleted successfully!');
                    loadAdminUpdates();
                } catch (error) {
                    console.error('Error deleting update:', error);
                    alert('Failed to delete update: ' + error.message);
                }
            }
        }

        // --- Upcoming Updates ---
        async function loadUpcomingUpdates() {
            upcomingUpdatesList.innerHTML = '';
            const upcomingUpdatesSnapshot = await db.collection('upcoming_updates').orderBy('timestamp', 'desc').get();
            upcomingUpdatesSnapshot.forEach(doc => {
                const update = doc.data();
                const date = update.timestamp ? new Date(update.timestamp.toDate()).toLocaleString() : 'N/A';
                const li = `
                    <li class="card flex justify-between items-center">
                        <div>
                            <p class="text-orange-400 font-bold mb-1">Upcoming Update:</p>
                            <p class="text-sm text-gray-400 mb-2">${date}</p>
                            <p>${update.content}</p>
                        </div>
                        <div>
                            <button onclick="editUpcomingUpdate('${doc.id}')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-md text-sm mr-2">Edit</button>
                            <button onclick="deleteUpcomingUpdate('${doc.id}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-md text-sm">Delete</button>
                        </div>
                    </li>
                `;
                upcomingUpdatesList.innerHTML += li;
            });
        }

        addUpcomingUpdateBtn.addEventListener('click', () => {
            upcomingUpdateModalTitle.innerText = 'Add New Upcoming Update';
            upcomingUpdateForm.reset();
            document.getElementById('upcomingUpdateId').value = '';
            upcomingUpdateModal.style.display = 'flex';
        });

        upcomingUpdateForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('upcomingUpdateId').value;
            const content = document.getElementById('upcomingUpdateContent').value;

            const updateData = {
                content,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                if (id) {
                    await db.collection('upcoming_updates').doc(id).update(updateData);
                    alert('Upcoming update updated successfully!');
                } else {
                    await db.collection('upcoming_updates').add(updateData);
                    alert('Upcoming update added successfully!');
                }
                closeModal('upcomingUpdateModal');
                loadUpcomingUpdates();
            } catch (error) {
                console.error('Error saving upcoming update:', error);
                alert('Failed to save upcoming update: ' + error.message);
            }
        });

        async function editUpcomingUpdate(id) {
            const doc = await db.collection('upcoming_updates').doc(id).get();
            const update = doc.data();
            upcomingUpdateModalTitle.innerText = 'Edit Upcoming Update';
            document.getElementById('upcomingUpdateId').value = id;
            document.getElementById('upcomingUpdateContent').value = update.content;
            upcomingUpdateModal.style.display = 'flex';
        }

        async function deleteUpcomingUpdate(id) {
            if (confirm('Are you sure you want to delete this upcoming update?')) {
                try {
                    await db.collection('upcoming_updates').doc(id).delete();
                    alert('Upcoming update deleted successfully!');
                    loadUpcomingUpdates();
                } catch (error) {
                    console.error('Error deleting upcoming update:', error);
                    alert('Failed to delete upcoming update: ' + error.message);
                }
            }
        }

        // --- General Modal Functions ---
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        window.onclick = function(event) {
            if (event.target == tournamentModal) {
                closeModal('tournamentModal');
            }
            if (event.target == updateModal) {
                closeModal('updateModal');
            }
            if (event.target == upcomingUpdateModal) {
                closeModal('upcomingUpdateModal');
            }
            if (event.target == adminLoginModal && currentAdminUser === null) {
                // Prevent closing login modal if not logged in
            }
        };

        // Initial load
        document.addEventListener('DOMContentLoaded', () => {
            // This will be handled by auth.onAuthStateChanged
        });
    </script>
</body>
</html>
