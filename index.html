<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>KILL STREAK - Free Fire Tournament</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <style>
      body {
        margin: 0;
        padding: 0;
        background-color: #1f2937; /* Changed from #ffffff to a dark gray */
      }

      .hero-bg {
        background-image: linear-gradient(
            rgba(0, 0, 0, 0.7),
            rgba(0, 0, 0, 0.7)
          ),
          url('https://wallpaperaccess.com/full/2092748.png');
        background-size: cover;
        background-position: center;
      }

      .leaderboard-row:nth-child(1) {
        background: linear-gradient(
          90deg,
          rgba(212, 175, 55, 0.3) 0%,
          rgba(212, 175, 55, 0.1) 50%,
          rgba(0, 0, 0, 0) 100%
        );
      }

      .leaderboard-row:nth-child(2) {
        background: linear-gradient(
          90deg,
          rgba(192, 192, 192, 0.3) 0%,
          rgba(192, 192, 192, 0.1) 50%,
          rgba(0, 0, 0, 0) 100%
        );
      }

      .pro-play-bg {
        background-image: linear-gradient(
            rgba(0, 0, 0, 0.7),
            rgba(0, 0, 0, 0.7)
          ),
          url('https://example.com/pro-play-bg.jpg');
      }

      /* Modal styles */
      .modal {
        display: none;
        position: fixed;
        z-index: 100;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.7);
        justify-content: center;
        align-items: center;
      }

      .modal-content {
        background-color: #1f2937;
        margin: auto;
        padding: 2rem;
        border: 1px solid #f97316;
        border-radius: 0.75rem;
        width: 90%;
        max-width: 500px;
        position: relative;
      }

      .close-button {
        color: #aaa;
        position: absolute;
        top: 10px;
        right: 20px;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
      }

      .close-button:hover,
      .close-button:focus {
        color: white;
        text-decoration: none;
        cursor: pointer;
      }

      .form-group {
        margin-bottom: 1rem;
      }

      .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        color: #d1d5db;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 0.75rem;
        border-radius: 0.375rem;
        border: 1px solid #4b5563;
        background-color: #374151;
        color: #f3f4f6;
      }

      /* Mobile Navigation Overlay */
      .mobile-nav-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.9);
        z-index: 40;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }

      .mobile-nav-overlay.active {
        display: flex;
      }

      .mobile-nav-overlay a {
        color: #d1d5db;
        font-size: 1.5rem;
        margin-bottom: 1.5rem;
        text-decoration: none;
      }

      .mobile-nav-overlay a:hover {
        color: #fb923c;
      }

      .close-mobile-nav {
        position: absolute;
        top: 20px;
        right: 20px;
        color: #fff;
        font-size: 2rem;
        cursor: pointer;
      }

      /* Profile Icon Styling */
      .profile-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: #f97316;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: white;
        font-size: 1.25rem;
        cursor: pointer;
        transition: background-color 0.3s ease;
      }

      .profile-icon:hover {
        background-color: #ea580c;
      }
    </style>
  </head>
  <body>
    <!-- Header/Navbar -->
    <header
      class="bg-black py-4 px-6 fixed w-full z-50 border-b border-orange-500"
    >
      <div class="container mx-auto flex justify-between items-center">
        <!-- Title adjusted to corner -->
        <div class="flex items-center">
          <span class="text-2xl font-bold text-orange-500">KILL STREAK</span>
        </div>

        <!-- Desktop Navigation -->
        <nav class="hidden md:flex space-x-8 items-center">
          <!-- MODIFIED: Home button to scroll to top -->
          <a
            href="#home"
            class="text-orange-400 hover:text-orange-300 font-medium"
            onclick="scrollToHome()"
            >Home</a
          >
          <a
            href="#tournaments"
            class="text-gray-300 hover:text-orange-300 font-medium"
            onclick="showViewTournamentSection()"
            >View Tournament</a
          >
          <a href="#teams" class="text-gray-300 hover:text-orange-300 font-medium"
            >Teams</a
          >
          <a
            href="#leaderboard"
            class="text-gray-300 hover:text-orange-300 font-medium"
            onclick="showLeaderboardSection()"
            >Leaderboard</a
          >
          <a
            href="#terms"
            class="text-gray-300 hover:text-orange-300 font-medium"
            >Terms and Conditions</a
          >
          <!-- ADDED/MODIFIED: Onclick for Battle Royale -->
          <a
            href="#pro-play"
            class="text-gray-300 hover:text-orange-300 font-medium"
            onclick="showBattleRoyaleSection()"
            >Battle Royale</a
          >
          <!-- ADDED/MODIFIED: Onclick for Rules -->
          <a
            href="#rules"
            class="text-gray-300 hover:text-orange-300 font-medium"
            onclick="showRulesSection()"
            >Rules</a
          >
          <!-- ADDED/MODIFIED: Onclick for Contact Us -->
          <a
            href="#contact"
            class="text-gray-300 hover:text-orange-300 font-medium"
            onclick="showContactSection()"
            >Contact Us</a
          >
        </nav>

        <div class="flex items-center space-x-4">
          <!-- Wallet Section - Always visible -->
          <div
            id="walletSection"
            class="flex items-center space-x-2 bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded-md cursor-pointer transition duration-300"
            onclick="openWalletModal()"
          >
            <i class="fas fa-wallet text-orange-400"></i>
            <span class="font-medium text-white">₹0.00</span>
          </div>

          <!-- Profile Icon - Initially hidden -->
          <div id="profileIcon" class="profile-icon" onclick="showProfileSection()">
            <i id="profileGenericIcon" class="fas fa-user text-white"></i>
            <span id="profileInitial" class="hidden"></span>
          </div>

          <!-- Mobile Menu Button (Hamburger) - Visible only on small screens -->
          <button class="md:hidden text-gray-300" onclick="toggleMobileMenu()">
            <i class="fas fa-bars text-2xl"></i>
          </button>
        </div>
      </div>
    </header>

    <!-- Mobile Navigation Overlay -->
    <div id="mobileNavOverlay" class="mobile-nav-overlay">
      <span class="close-mobile-nav" onclick="toggleMobileMenu()">×</span>
      <!-- MODIFIED: Home button to scroll to top -->
      <a
        class="text-gray-300 hover:text-orange-300 font-medium"
        onclick="location.reload();"
        >Home</a
      >
      <a
        href="#tournaments"
        onclick="toggleMobileMenu(); showViewTournamentSection();"
        >View Tournament</a
      >
      <a href="#teams" onclick="toggleMobileMenu()">Teams</a>
      <a href="#leaderboard" onclick="toggleMobileMenu(); showLeaderboardSection();"
        >Leaderboard</a
      >
      <a
        href="#profile"
        onclick="toggleMobileMenu(); showProfileSection();"
        >Your Registration</a
      >
      <!-- ADDED/MODIFIED: Onclick for Battle Royale in mobile nav -->
      <a
        href="#pro-play"
        onclick="toggleMobileMenu(); showBattleRoyaleSection();"
        >Battle Royale</a
      >
      <!-- ADDED/MODIFIED: Onclick for Rules in mobile nav -->
      <a href="#rules" onclick="toggleMobileMenu(); showRulesSection();"
        >Rules</a
      >
      <!-- ADDED/MODIFIED: Onclick for Contact Us in mobile nav -->
      <a href="#contact" onclick="toggleMobileMenu(); showContactSection();"
        >Contact Us</a
      >
      <a
        href="#profile"
        id="profileNavLinkMobile"
        class="text-gray-300 hover:text-orange-300 font-medium hidden"
        onclick="toggleMobileMenu(); showProfileSection();"
        >Profile</a
      >
    </div>

    <!-- Home Section -->
    <section id="home" class="hero-bg bg-cover bg-center pt-24 text-white">
      <div class="container mx-auto px-6 py-20 md:py-28">
        <div class="max-w-2xl mx-auto text-center">
          <h1 class="text-4xl md:text-6xl font-bold mb-2 text-orange-400">
            KILL STREAK
          </h1>
          <p class="text-xl font-medium text-yellow-300 mb-2">
            India's Biggest Free Fire Tournament
          </p>
          <p class="text-lg mb-2 text-gray-300">
            Proudly Organised in Rajasthan, India
          </p>
          <p class="text-xl mb-8">Compete against India's best Free Fire players</p>
          <div class="flex flex-col md:flex-row justify-center gap-4">
            <a
              href="#"
              id="loginSignupJoinBtn"
              onclick="openLoginSignupModal()"
              class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-8 rounded-md transition duration-300"
              >Login/Signup and Join Tournament</a
            >
          </div>
          <div class="mt-6 text-center">
            <button
              onclick="downloadHTML()"
              class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-md shadow-lg flex items-center justify-center mx-auto gap-2"
            >
              <i class="fas fa-download"></i> Download HTML Code
            </button>
          </div>
          <!-- NEW: WhatsApp Community Button -->
          <div class="mt-4 text-center">
            <a
              href="YOUR_WHATSAPP_COMMUNITY_LINK_HERE"
              target="_blank"
              class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-md shadow-lg flex items-center justify-center mx-auto gap-2"
            >
              <i class="fab fa-whatsapp mr-2"></i> JOIN WHATSAPP COMMUNITY
            </a>
            <p class="text-gray-400 text-sm mt-2">
              Join the Whatsapp community group for all tournament updates
            </p>
          </div>
          <!-- NEW: Upcoming Tournament Button -->
          <div class="mt-4 text-center">
            <button
              onclick="checkLoginAndShowUpcomingTournaments()"
              class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-6 rounded-md shadow-lg flex items-center justify-center mx-auto gap-2"
            >
              <i class="fas fa-calendar-alt mr-2"></i> UPCOMING TOURNAMENT
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- Battle Royale Mode Section -->
    <section id="pro-play" class="relative py-16 bg-gray-800">
      <div class="container mx-auto px-6">
        <h2 class="text-3xl font-bold text-center mb-4 text-orange-400">
          BATTLE ROYALE MODE
        </h2>
        <div
          class="max-w-md mx-auto bg-gray-900 rounded-xl p-6 border border-orange-500"
        >
          <div class="flex flex-col items-center">
            <img
              src="https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/5fb37235-b13a-4616-8c1f-4e3525140e24.png"
              alt="Battle Royale Tournament"
              class="w-full rounded-lg mb-4"
              width="800"
              height="450"
            />
            <div class="bg-gray-800 rounded-lg p-4 w-full mb-4">
              <p class="text-center text-white font-medium mb-2">
                Pro Tournament Features:
              </p>
              <ul class="space-y-2">
                <li class="flex items-center px-2 text-white">
                  <i class="fas fa-check text-red-500 mr-2"></i> Advanced
                  matchmaking system
                </li>
                <li class="flex items-center px-2 text-white">
                  <i class="fas fa-check text-red-500 mr-2"></i> Pro-level
                  tournament settings
                </li>
                <li class="flex items-center px-2 text-white">
                  <i class="fas fa-check text-red-500 mr-2"></i> Competitive
                  ranking ladder
                </li>
              </ul>
            </div>
            <p
              id="registrationStatus"
              class="text-center text-orange-400 font-bold my-4"
            ></p>
            <button
              id="registerButton"
              onclick="checkLoginAndOpenRegisterModal()"
              class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-8 rounded-md transition duration-300 w-full"
            >
              Join Now
            </button>
            <button
              id="viewTournamentBtn"
              onclick="checkRegistrationThenShowTournament()"
              class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-8 rounded-md transition duration-300 w-full mt-4"
            >
              View Tournament
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- RULES Section -->
    <section id="rules" class="relative py-16 overflow-hidden bg-gray-900">
      <!-- Video Background -->
      <div
        class="absolute inset-0 z-0 bg-gradient-to-br from-orange-900 to-black opacity-80"
      ></div>
      <video
        autoplay=""
        muted=""
        loop=""
        class="absolute z-0 w-auto min-w-full min-h-full max-w-none object-cover opacity-50"
      >
        <source
          src="https://assets.mixkit.co/videos/preview/mixkit-fire-effect-3787-large.mp4"
          type="video/mp4"
        />
      </video>
      <div class="container mx-auto px-6">
        <h2 class="text-3xl font-bold text-center mb-12 text-orange-400">
          RULES AND REGULATIONS
        </h2>
        <div
          class="relative z-10 max-w-3xl mx-auto bg-gray-900/80 backdrop-blur-sm rounded-xl p-8 border border-orange-500"
        >
          <div class="grid md:grid-cols-2 gap-8 text-white">
            <div>
              <h3 class="text-xl font-bold mb-4 text-orange-400">General Rules</h3>
              <ul class="space-y-2 mb-6">
                <li class="flex items-center">
                  <i class="fas fa-check-circle mr-2 text-orange-400"></i> 1.) Any
                  kind of cheating, hacking, or using third-party tools will lead
                  to disqualification.
                </li>
                <li class="flex items-center">
                  <i class="fas fa-check-circle mr-2 text-orange-400"></i> 2.)
                  Respectful behavior is expected. Any kind of abusive language,
                  threats, or toxicity will result in penalties or bans.
                </li>
                <li class="flex items-center">
                  <i class="fas fa-check-circle mr-2 text-orange-400"></i> 3.) A
                  team must consist of 4 players (optional 1 substitute depending
                  on rules).
                </li>
                <li class="flex items-center">
                  <i class="fas fa-check-circle mr-2 text-orange-400"></i> 4.) A
                  player cannot play for more than one team during the tournament.
                </li>
                <li class="flex items-circle mr-2 text-orange-400">
                  5.) Maps: Bermuda, Purgatory, Kalahari (depends on the
                  organizer).
                </li>
              </ul>
            </div>
            <div>
              <img
                src="https://i.pinimg.com/originals/14/d9/d3/14d9d3542d73938d3fc66cf8d4d6f77b.jpg"
                alt="Note:- No Cheating and Play with honestly gameplay"
                class="w-full rounded-lg"
              />
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Profile Section (Initially Hidden) -->
    <section id="profile" class="relative py-16 bg-gray-800 hidden">
      <div class="container mx-auto px-6">
        <h2 class="text-3xl font-bold text-center mb-8 text-orange-400">
          Your Profile
        </h2>
        <div
          class="max-w-md mx-auto bg-gray-900 rounded-xl p-6 border border-orange-500 text-white relative"
        >
          <span class="close-button" onclick="hideProfileSection()">×</span>
          <div class="flex flex-col items-center mb-6">
            <div
              class="profile-icon w-24 h-24 text-4xl mb-4 border-2 border-orange-500"
            >
              <span id="profileAvatarInitial"></span>
            </div>
            <h3 class="text-2xl font-bold text-orange-400" id="profileUserName">
              PRIYANSHU
            </h3>
            <p class="text-gray-300" id="profileUserEmail">
              cyber.securiity.instagrames@gmail.com
            </p>
            <p class="text-gray-300" id="profileUserMobile">N/A</p>
          </div>
          <div class="space-y-4">
            <div>
              <p class="font-medium text-orange-400">Registered Tournaments:</p>
              <!-- MODIFIED: List for registered tournaments -->
              <ul
                id="registeredTournamentsList"
                class="list-disc list-inside text-gray-300 ml-4"
              >
                <li>
                  <strong>Mode:</strong> Solo<br />
                  <strong>Player 1:</strong> Priyanshu FF (UID: 8693934016)<br />

                  <em>Registered on: 7/27/2025, 4:37:21 PM</em>
                </li>
              </ul>
            </div>
            <button
              onclick="logoutUser()"
              class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-8 rounded-md transition duration-300 w-full mt-4"
            >
              Logout
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- New View Tournament Section -->
    <section id="view-tournament" class="relative py-16 bg-gray-800 hidden pt-24">
      <div class="container mx-auto px-6">
        <h2 class="text-3xl font-bold text-center mb-8 text-orange-400">
          Free Fire Tournament
        </h2>
        <div
          class="max-w-3xl mx-auto bg-gray-900 rounded-xl p-6 border border-orange-500 text-white relative"
        >
          <span class="close-button" onclick="hideViewTournamentSection()">×</span>
          <h3 class="text-xl font-bold mb-4 text-orange-400">Latest Updates:</h3>
          <div id="adminUpdates" class="space-y-4 text-gray-300">
            <p class="text-red-500">Error loading updates.</p>
          </div>

          <!-- Tournament Details for Registered Users -->
          <div id="registeredTournamentDetails" class="mt-8 hidden">
            <h3 class="text-xl font-bold mb-4 text-orange-400">
              Your Registered Tournament Details:
            </h3>
            <div class="bg-gray-800 p-4 rounded-md shadow-lg">
              <p>
                <strong>Tournament Name:</strong>
                <span id="displayTournamentName"></span>
              </p>
              <p>
                <strong>Mode:</strong> <span id="displayTournamentMode"></span>
              </p>
              <p>
                <strong>Entry Fee:</strong>
                <span id="displayTournamentEntryFee"></span>
              </p>
              <p>
                <strong>Prize Pool:</strong>
                <span id="displayTournamentPrizePool"></span>
              </p>
              <p>
                <strong>Date & Time:</strong>
                <span id="displayTournamentDateTime"></span>
              </p>
              <p class="mt-4">
                <strong>Rules/Description:</strong>
                <span id="displayTournamentDescription"></span>
              </p>

              <div class="mt-4">
                <p class="font-bold text-orange-400">Room Details:</p>
                <div class="flex items-center mt-2">
                  <p class="mr-2">
                    <strong>Room ID:</strong> <span id="displayRoomId"></span>
                  </p>
                  <button
                    onclick="copyToClipboard('displayRoomId')"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-md text-sm"
                  >
                    Copy
                  </button>
                </div>
                <div class="flex items-center mt-2">
                  <p class="mr-2">
                    <strong>Password:</strong>
                    <span id="displayRoomPassword"></span>
                  </p>
                  <button
                    onclick="copyToClipboard('displayRoomPassword')"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-md text-sm"
                  >
                    Copy
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- New Upcoming Tournaments Section -->
    <section
      id="upcoming-tournaments"
      class="relative py-16 bg-gray-800 hidden pt-24"
    >
      <div class="container mx-auto px-6">
        <h2 class="text-3xl font-bold text-center mb-8 text-orange-400">
          FREE FIRE UPCOMING TOURNAMENT
        </h2>
        <div
          class="max-w-3xl mx-auto bg-gray-900 rounded-xl p-6 border border-orange-500 text-white relative"
        >
          <span
            class="close-button"
            onclick="hideUpcomingTournamentsSection()"
            >×</span
          >
          <h3 class="text-xl font-bold mb-4 text-orange-400">
            Latest Upcoming Tournament Updates:
          </h3>
          <div id="upcomingTournamentUpdates" class="space-y-4 text-gray-30">
            <p class="text-red-500">Error loading upcoming updates.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Leaderboard Section -->
    <section id="leaderboard" class="relative py-16 bg-gray-800 hidden pt-24">
      <div class="container mx-auto px-6">
        <h2 class="text-3xl font-bold text-center mb-8 text-orange-400">
          LEADERBOARD
        </h2>
        <div
          class="max-w-3xl mx-auto bg-gray-900 rounded-xl p-6 border border-orange-500 text-white relative"
        >
          <span class="close-button" onclick="hideLeaderboardSection()">×</span>
          <h3 class="text-xl font-bold mb-4 text-orange-400">Top Players:</h3>
          <div id="leaderboardContent" class="space-y-4 text-gray-300">
            <!-- Leaderboard data will be loaded here -->
            <p>Leaderboard data coming soon!</p>
            <!-- Example:
            <div class="leaderboard-row bg-gray-800 p-3 rounded-md flex justify-between items-center">
                <span class="font-bold text-lg text-orange-400">1. PlayerOne</span>
                <span>Kills: 25 | Points: 150</span>
            </div>
            -->
          </div>
        </div>
      </div>
    </section>

    <!-- Contact Us Section -->
    <section id="contact" class="relative py-16 bg-gray-800">
      <div class="container mx-auto px-6">
        <h2 class="text-3xl font-bold text-center mb-8 text-orange-400">
          Contact Us
        </h2>
        <div
          class="max-w-md mx-auto bg-gray-900 rounded-xl p-6 border border-orange-500 text-white"
        >
          <form action="https://formsubmit.co/jangidrajat715@gmail.com" method="POST">
            <input type="hidden" name="_captcha" value="false" />

            <div class="form-group">
              <label for="contactName">Your Name:</label>
              <input
                type="text"
                id="contactName"
                name="name"
                placeholder="Enter your name"
                required=""
              />
            </div>
            <div class="form-group">
              <label for="contactEmail">Your Email:</label>
              <input
                type="email"
                id="contactEmail"
                name="email"
                placeholder="Enter your email"
                required=""
              />
            </div>
            <div class="form-group">
              <label for="contactSubject">Subject:</label>
              <input
                type="text"
                id="contactSubject"
                name="subject"
                placeholder="Subject of your message"
                required=""
              />
            </div>
            <div class="form-group">
              <label for="contactMessage">Message:</label>
              <textarea
                id="contactMessage"
                name="message"
                rows="5"
                placeholder="Your message"
                required=""
              ></textarea>
            </div>
            <button
              type="submit"
              class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-8 rounded-md transition duration-300 w-full mt-4"
            >
              Send Message
            </button>
          </form>
        </div>
      </div>
    </section>

    <!-- Wallet Modal -->
    <div id="walletModal" class="modal">
      <div class="modal-content">
        <span class="close-button" onclick="closeWalletModal()">×</span>
        <h2 class="text-2xl font-bold text-center mb-6 text-orange-400">
          Your Wallet
        </h2>
        <p class="text-center text-white text-xl mb-6">
          Current Balance:
          <span class="font-bold text-orange-400" id="currentWalletBalance"
            >₹0.00</span
          >
        </p>
        <div id="walletMainContent">
          <div class="flex flex-col gap-4">
            <button
              onclick="showPaymentMethodSelection()"
              class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-md transition duration-300"
            >
              Add Money
            </button>
            <button
              onclick="showWithdrawalForm()"
              class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-8 rounded-md transition duration-300"
            >
              Withdraw Money
            </button>
          </div>
        </div>

        <!-- Payment Method Selection (Add Money) -->
        <div id="paymentMethodSelection" class="hidden">
          <h3 class="text-xl font-bold text-center mb-4 text-orange-400">
            Select Payment Method
          </h3>
          <button
            onclick="showDepositAmountInput()"
            class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-8 rounded-md transition duration-300 w-full"
          >
            PAY UPI/QR CODE INSTANTLY
          </button>
        </div>

        <!-- Deposit Amount Input (Add Money) -->
        <div id="depositAmountInput" class="hidden">
          <h3 class="text-xl font-bold text-center mb-4 text-orange-400">
            For 'Add Fund To Your Account Click On deposit amount.'
          </h3>
          <button
            onclick="showAmountPrompt()"
            class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-8 rounded-md transition duration-300 w-full"
          >
            Deposit Amount
          </button>
        </div>

        <!-- Amount Prompt (Add Money) -->
        <div id="amountPrompt" class="hidden">
          <div class="form-group">
            <label for="depositAmount">Enter Amount:</label>
            <input
              type="number"
              id="depositAmount"
              placeholder="Enter amount"
              class="w-full p-3 rounded-md border border-gray-600 bg-gray-700 text-white"
              required=""
            />
          </div>
          <div class="flex justify-center gap-4 mt-4">
            <button
              onclick="processAmount()"
              class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-md transition duration-300"
            >
              OK
            </button>
            <button
              onclick="cancelAmountPrompt()"
              class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-md transition duration-300"
            >
              Cancel
            </button>
          </div>
        </div>

        <!-- QR Code and UPI Details Input (Add Money) -->
        <div id="qrCodeSection" class="hidden">
          <p class="text-center text-red-500 font-bold mb-4">
            PLEASE CHECK QR CODE BEFORE PAY
          </p>
          <p class="text-center text-white mb-4">
            SCAN THIS QR CODE WITH YOUR ANY UPI APP - Paytm,Phonepe,Gpay, e.t.c.
          </p>
          <div class="flex justify-center mb-6">
            <img
              src="https://iili.io/F89FEss.md.jpg"
              alt="QR Code"
              class="w-48 h-48 border border-orange-500 rounded-lg"
            />
          </div>

          <div class="form-group">
            <label for="descriptionBox" class="text-orange-400">Description:</label>
            <textarea
              id="descriptionBox"
              rows="3"
              class="w-full p-3 rounded-md border border-gray-600 bg-gray-700 text-white"
              readonly=""
            >Step 1 - Put amount &amp; UPI Transaction ID/UTR/UPI Reference No.
Step 2 - Click on Pay Button</textarea>
          </div>

          <div class="form-group">
            <label for="upiTransactionId" class="text-orange-400"
              >UPI Transaction ID/UTR/UPI Reference No.:</label
            >
            <input
              type="text"
              id="upiTransactionId"
              placeholder="Enter UPI Transaction ID"
              class="w-full p-3 rounded-md border border-gray-600 bg-gray-700 text-white"
              required=""
            />
          </div>

          <div class="form-group">
            <label for="enteredAmount" class="text-orange-400">Amount:</label>
            <input
              type="number"
              id="enteredAmount"
              placeholder="Enter Amount"
              class="w-full p-3 rounded-md border border-gray-600 bg-gray-700 text-white"
              required=""
            />
          </div>

          <button
            onclick="submitUpiDetails()"
            class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-8 rounded-md transition duration-300 w-full mt-4"
          >
            Pay Now
          </button>

          <div class="mt-6 text-gray-300 text-sm">
            <h4 class="font-bold text-orange-400 mb-2">HOW TO DEPOSIT?</h4>
            <p>Scan this QR with Any Indian Bank Or App</p>
            <p>Pay Your Amount</p>
            <p class="mb-4">
              Enter Bank reference, UTR number and amount in Add Money section.
            </p>

            <h4 class="font-bold text-orange-400 mb-2">
              BELOW SOME EXAMPLES OF UTR OR REFERENCE NUMBER AND YOU CAN PAY
              THROUGH ANY BANK APP FOR DEPOSIT.
            </h4>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
              <a href="https://freeimage.host/i/Fv7bMzv"
                ><img
                  src="https://iili.io/Fv7bMzv.md.jpg"
                  alt="Fv7bMzv.md.jpg"
                  border="0"
                  class="w-full h-auto rounded-md"
              /></a>
              <a href="https://freeimage.host/"
                ><img
                  src="https://iili.io/Fv7bag1.jpg"
                  alt="Fv7bag1.jpg"
                  border="0"
                  class="w-full h-auto rounded-md"
              /></a>
              <a href="https://freeimage.host/"
                ><img
                  src="https://iili.io/Fv7bY0P.jpg"
                  alt="Fv7bY0P.jpg"
                  border="0"
                  class="w-full h-auto rounded-md"
              /></a>
              <a href="https://freeimage.host/"
                ><img
                  src="https://iili.io/Fv7b1ea.jpg"
                  alt="Fv7b1ea.jpg"
                  border="0"
                  class="w-full h-auto rounded-md"
              /></a>
              <a href="https://freeimage.host/"
                ><img
                  src="https://iili.io/Fv7bY0P.jpg"
                  alt="Fv7bY0P.jpg"
                  border="0"
                  class="w-full h-auto rounded-md"
              /></a>
            </div>
          </div>
        </div>

        <!-- Withdrawal Form -->
        <div id="withdrawalForm" class="hidden">
          <p class="text-center text-white mb-4">
            Withdraw money in Gpay/Paytm/Phonepay
          </p>
          <div class="form-group">
            <label for="withdrawName">NAME:</label>
            <input
              type="text"
              id="withdrawName"
              placeholder="Enter your name"
              class="w-full p-3 rounded-md border border-gray-600 bg-gray-700 text-white"
              required=""
            />
          </div>
          <div class="form-group">
            <label for="withdrawUpiId">UPI ID:</label>
            <input
              type="text"
              id="withdrawUpiId"
              placeholder="Enter UPI ID"
              class="w-full p-3 rounded-md border border-gray-600 bg-gray-700 text-white"
              required=""
            />
          </div>
          <div class="form-group">
            <label for="withdrawAmount">AMOUNT:</label>
            <input
              type="number"
              id="withdrawAmount"
              placeholder="Enter amount"
              class="w-full p-3 rounded-md border border-gray-600 bg-gray-700 text-white"
              required=""
            />
          </div>
          <button
            onclick="processWithdrawal()"
            class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-8 rounded-md transition duration-300 w-full mt-4"
          >
            Withdraw Now
          </button>
        </div>
      </div>
    </div>
    <div id="loginSignupModal" class="modal" style="display: none">
      <div class="modal-content">
        <span class="close-button" onclick="closeLoginSignupModal()">×</span>
        <h2
          class="text-2xl font-bold text-center mb-6 text-orange-400"
          id="loginSignupTitle"
        >
          Sign Up
        </h2>

        <!-- Signup with Email Form (default) -->
        <form id="signupEmailForm" class="" onsubmit="signUpUser(event)">
          <div class="form-group">
            <label for="signupEmailFFName">IN GAME FF NAME:</label>
            <input
              type="text"
              id="signupEmailFFName"
              placeholder="Enter your In-Game FF Name"
              required=""
            />
          </div>
          <div class="form-group">
            <label for="signupEmail">Email ID:</label>
            <input
              type="email"
              id="signupEmail"
              placeholder="Enter your email ID"
              required=""
            />
          </div>
          <div class="form-group">
            <label for="signupPassword">Password:</label>
            <input
              type="password"
              id="signupPassword"
              placeholder="Create a password"
              required=""
            />
          </div>
          <button
            type="submit"
            class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-8 rounded-md transition duration-300 w-full mt-4"
          >
            Sign Up with Email
          </button>
          <p class="text-center text-gray-400 mt-4">
            Already have an account?
            <a href="#" class="text-orange-400 hover:underline" onclick="showLoginForm()"
              >Login</a
            >
          </p>
        </form>

        <!-- Signup with Mobile Form (hidden by default) - Firebase Phone Auth is more complex, this is a placeholder -->
        <form id="signupMobileForm" class="hidden">
          <div class="form-group">
            <label for="signupMobileFFName">IN GAME FF NAME:</label>
            <input
              type="text"
              id="signupMobileFFName"
              placeholder="Enter your In-Game FF Name"
              required=""
            />
          </div>
          <div class="form-group">
            <label for="signupMobileNumber">Mobile Number:</label>
            <input
              type="tel"
              id="signupMobileNumber"
              placeholder="Enter your mobile number"
              pattern="[0-9]{10}"
              title="Please enter a 10-digit mobile number"
              required=""
            />
          </div>
          <button
            type="submit"
            class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-8 rounded-md transition duration-300 w-full mt-4"
          >
            Sign Up with Mobile
          </button>
          <p class="text-center text-gray-400 mt-4">
            Already have an account?
            <a href="#" class="text-orange-400 hover:underline" onclick="showLoginForm()"
              >Login</a
            >
          </p>
          <div class="text-center my-4 text-gray-400">OR</div>
          <button
            type="button"
            onclick="showSignupEmailForm()"
            class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-8 rounded-md transition duration-300 w-full flex items-center justify-center gap-2"
          >
            <i class="fas fa-envelope"></i> Sign Up with Email
          </button>
        </form>

        <!-- Login Form (hidden by default) -->
        <form id="loginForm" class="hidden">
          <div class="form-group">
            <label for="loginEmail">Email:</label>
            <input type="email" id="loginEmail" placeholder="Enter your email" />
          </div>
          <div class="form-group">
            <label for="loginPassword">Password:</label>
            <input
              type="password"
              id="loginPassword"
              placeholder="Enter your password"
              required=""
            />
          </div>
          <button
            type="submit"
            class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-8 rounded-md transition duration-300 w-full mt-4"
          >
            Login
          </button>
          <p class="text-center text-gray-400 mt-4">
            Don't have an account?
            <a
              href="#"
              class="text-orange-400 hover:underline"
              onclick="showSignupEmailForm()"
              >Sign Up</a
            >
          </p>
          <!-- NEW: Forgot Password Button -->
          <p class="text-center text-gray-400 mt-2">
            <a
              href="#"
              class="text-orange-400 hover:underline"
              onclick="forgotPassword()"
              >Forgot Password?</a
            >
          </p>
          <div class="text-center my-4 text-gray-400">OR</div>
          <button
            type="button"
            onclick="googleSignIn()"
            class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-md transition duration-300 w-full flex items-center justify-center gap-2"
          >
            <i class="fab fa-google"></i> Login with Gmail
          </button>
        </form>
      </div>
    </div>

    <!-- Registration Modal -->
    <div id="registerModal" class="modal">
      <div class="modal-content">
        <span class="close-button" onclick="closeRegisterModal()">×</span>
        <h2 class="text-2xl font-bold text-center mb-6 text-orange-400">
          Register for Tournament
        </h2>
        <form id="registrationForm" onsubmit="registerTournament(event)">
          <div class="form-group">
            <label for="selectTournament">Select Tournament:</label>
            <select id="selectTournament" class="w-full p-3 rounded-md border border-gray-600 bg-gray-700 text-white" onchange="updateRegistrationFormForTournament()" required>
                <option value="">-- Select a Tournament --</option>
            </select>
          </div>
          <p class="text-sm text-gray-400 mb-4">
            Available Seats: <span id="availableSeatsDisplay">N/A</span> / Total Seats: <span id="totalSeatsDisplay">N/A</span>
          </p>

          <!-- Player 1 (Always visible) -->
          <div class="form-group">
            <label for="player1Name">Player 1 In-Game Name:</label>
            <input
              type="text"
              id="player1Name"
              placeholder="Enter In-Game Name"
              required=""
            />
          </div>
          <div class="form-group">
            <label for="player1UID">Player 1 FF UID:</label>
            <input
              type="text"
              id="player1UID"
              placeholder="Enter Free Fire UID"
              required=""
            />
          </div>

          <!-- Player 2 (Duo/Squads) -->
          <div id="player2Fields" class="hidden">
            <h3 class="text-xl font-bold mt-4 mb-2 text-orange-400">
              Player 2 Details
            </h3>
            <div class="form-group">
              <label for="player2Name">Player 2 In-Game Name:</label>
              <input
                type="text"
                id="player2Name"
                placeholder="Enter In-Game Name"
              />
            </div>
            <div class="form-group">
              <label for="player2UID">Player 2 FF UID:</label>
              <input
                type="text"
                id="player2UID"
                placeholder="Enter Free Fire UID"
              />
            </div>
          </div>

          <!-- Player 3 (Squads) -->
          <div id="player3Fields" class="hidden">
            <h3 class="text-xl font-bold mt-4 mb-2 text-orange-400">
              Player 3 Details
            </h3>
            <div class="form-group">
              <label for="player3Name">Player 3 In-Game Name:</label>
              <input
                type="text"
                id="player3Name"
                placeholder="Enter In-Game Name"
              />
            </div>
            <div class="form-group">
              <label for="player3UID">Player 3 FF UID:</label>
            <input type="text" id="player3UID" placeholder="Enter Free Fire UID">
            </div>
          </div>

          <!-- Player 4 (Squads) -->
          <div id="player4Fields" class="hidden">
            <h3 class="text-xl font-bold mt-4 mb-2 text-orange-400">
              Player 4 Details
            </h3>
            <div class="form-group">
              <label for="player4Name">Player 4 In-Game Name:</label>
              <input
                type="text"
                id="player4Name"
                placeholder="Enter In-Game Name"
              />
            </div>
            <div class="form-group">
              <label for="player4UID">Player 4 FF UID:</label>
            <input type="text" id="player4UID" placeholder="Enter Free Fire UID">
            </div>
          </div>

          <button
            type="submit"
            id="completeRegistrationBtn"
            class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-8 rounded-md transition duration-300 w-full mt-6"
          >
            Complete Registration
          </button>
        </form>
      </div>
    </div>

    <footer class="bg-black py-4 text-center text-gray-400 text-sm">
      <p>CREATED BY PRB SQUAD</p>
    </footer>

    <script>
      // Firebase Configuration - REPLACE THIS WITH YOUR ACTUAL FIREBASE CONFIG
      const firebaseConfig = {
        apiKey: 'AIzaSyBwxgVlQ7dfi5nDLzWWSNWkQ2kam-M5wVs',
        authDomain: 'kill-streak-tournament-50303.firebaseapp.com',
        projectId: 'kill-streak-tournament-50303',
        storageBucket: 'kill-streak-tournament-50303.firebasestorage.app',
        messagingSenderId: '253309521755',
        appId: '1:253309521755:web:7799f296f0de38d84ed47e',
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore(); // Firestore initialization

      let isLoggedIn = false;
      let hasRegisteredForTournament = false;
      let currentUser = {
        uid: '', // Firebase User ID
        name: '',
        email: '',
        mobile: '', // Firebase Phone Auth is more complex, this will be empty for email/Google users
        registeredTournaments: [], // This would ideally be fetched from a database
      };

      // Simulated wallet balance (for demonstration purposes)
      let walletBalance = 0.0; // Initialize to 0.00
      let pendingDepositAmount = 0.0; // NEW: To store the amount entered before UPI details
      let availableTournaments = []; // To store tournaments fetched from Firestore

      // --- Firebase Authentication State Listener ---
      auth.onAuthStateChanged(async (user) => {
        if (user) {
          // User is signed in
          isLoggedIn = true;
          currentUser.uid = user.uid;
          currentUser.email = user.email || '';
          currentUser.mobile = user.phoneNumber || '';

          // Fetch user profile from Firestore
          try {
            const userDoc = await db.collection('users').doc(user.uid).get();
            if (userDoc.exists) {
              const userData = userDoc.data();
              currentUser.name =
                userData.name || user.displayName || user.email.split('@')[0];
              currentUser.email = userData.email || user.email;
              currentUser.mobile = userData.mobile || user.phoneNumber || ''; // Prioritize Firestore data
              walletBalance = userData.walletBalance || 0.0; // Fetch wallet balance
            } else {
              // If user document doesn't exist, use data from Firebase Auth
              currentUser.name = user.displayName || user.email.split('@')[0];
              currentUser.email = user.email;
              // Create user document with initial wallet balance
              await db.collection('users').doc(user.uid).set({
                name: currentUser.name,
                email: currentUser.email,
                walletBalance: 0.0,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              });
              walletBalance = 0.0;
            }
          } catch (error) {
            console.error('Error fetching user profile:', error);
            // Fallback to Firebase Auth data if Firestore fetch fails
            currentUser.name = user.displayName || user.email.split('@')[0];
            currentUser.email = user.email;
            walletBalance = 0.0; // Default to 0 if error
          }

          // Fetch registered tournaments from Firestore
          try {
            const registrationSnapshot = await db
              .collection('registrations')
              .where('userId', '==', user.uid)
              .get();
            currentUser.registeredTournaments = [];
            if (!registrationSnapshot.empty) {
              registrationSnapshot.forEach((doc) => {
                currentUser.registeredTournaments.push({
                  id: doc.id,
                  ...doc.data(),
                });
              });
              hasRegisteredForTournament = true;
            } else {
              hasRegisteredForTournament = false;
            }
          } catch (error) {
            console.error('Error fetching registration:', error);
            currentUser.registeredTournaments = [];
            hasRegisteredForTournament = false;
          }

          console.log('User logged in:', currentUser);
        } else {
          // User is signed out
          isLoggedIn = false;
          currentUser = {
            uid: '',
            name: '',
            email: '',
            mobile: '',
            registeredTournaments: [],
          };
          hasRegisteredForTournament = false; // Reset registration status on logout
          walletBalance = 0.0; // Reset wallet balance on logout
          console.log('User logged out.');
        }
        updateUI(); // Always update UI after auth state changes
      });

      // --- Utility Functions ---
      function downloadHTML() {
        const html = document.documentElement.outerHTML;
        const blob = new Blob([html], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'tournament_website.html';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      }

      function copyToClipboard(elementId) {
        const element = document.getElementById(elementId);
        if (element) {
          const textToCopy = element.innerText;
          navigator.clipboard
            .writeText(textToCopy)
            .then(() => {
              alert('Copied to clipboard: ' + textToCopy);
            })
            .catch((err) => {
              console.error('Failed to copy: ', err);
              alert('Failed to copy. Please try manually.');
            });
        }
      }

      // Get modals and elements
      var loginSignupModal = document.getElementById('loginSignupModal');
      var registerModal = document.getElementById('registerModal');
      var walletModal = document.getElementById('walletModal');
      var mobileNavOverlay = document.getElementById('mobileNavOverlay');
      var profileSection = document.getElementById('profile');
      var viewTournamentSection = document.getElementById('view-tournament');
      var upcomingTournamentsSection = document.getElementById(
        'upcoming-tournaments',
      );
      var leaderboardSection = document.getElementById('leaderboard'); // NEW
      var profileNavLinkMobile = document.getElementById('profileNavLinkMobile');
      var loginSignupJoinBtn = document.getElementById('loginSignupJoinBtn');
      var walletSection = document.getElementById('walletSection');
      var profileIcon = document.getElementById('profileIcon');
      var profileGenericIcon = document.getElementById('profileGenericIcon'); // NEW
      var profileInitial = document.getElementById('profileInitial'); // NEW
      var profileAvatarInitial = document.getElementById('profileAvatarInitial'); // NEW
      var joinNowBtn = document.getElementById('registerButton'); // Corrected ID
      var adminUpdatesDiv = document.getElementById('adminUpdates');
      var upcomingTournamentUpdatesDiv = document.getElementById(
        'upcomingTournamentUpdates',
      );

      // Wallet specific elements
      var walletMainContent = document.getElementById('walletMainContent');
      var paymentMethodSelection = document.getElementById(
        'paymentMethodSelection',
      );
      var depositAmountInput = document.getElementById('depositAmountInput');
      var amountPrompt = document.getElementById('amountPrompt');
      var qrCodeSection = document.getElementById('qrCodeSection');
      var depositAmountField = document.getElementById('depositAmount');
      var enteredAmountField = document.getElementById('enteredAmount');
      var withdrawalForm = document.getElementById('withdrawalForm');
      var currentWalletBalanceSpan = document.getElementById(
        'currentWalletBalance',
      );

      // Registration specific elements
      var selectTournamentDropdown = document.getElementById('selectTournament');
      var availableSeatsDisplay = document.getElementById('availableSeatsDisplay');
      var totalSeatsDisplay = document.getElementById('totalSeatsDisplay');
      var completeRegistrationBtn = document.getElementById('completeRegistrationBtn');

      // Tournament Details for Registered Users
      var registeredTournamentDetailsDiv = document.getElementById('registeredTournamentDetails');
      var displayTournamentName = document.getElementById('displayTournamentName');
      var displayTournamentMode = document.getElementById('displayTournamentMode');
      var displayTournamentEntryFee = document.getElementById('displayTournamentEntryFee');
      var displayTournamentPrizePool = document.getElementById('displayTournamentPrizePool');
      var displayTournamentDateTime = document.getElementById('displayTournamentDateTime');
      var displayTournamentDescription = document.getElementById('displayTournamentDescription');
      var displayRoomId = document.getElementById('displayRoomId');
      var displayRoomPassword = document.getElementById('displayRoomPassword');

      // --- Data Loading Functions ---
      async function fetchAvailableTournaments() {
        try {
          const tournamentsSnapshot = await db.collection('tournaments').get();
          availableTournaments = tournamentsSnapshot.docs.map((doc) => ({
            id: doc.id,
            ...doc.data(),
          }));
          populateTournamentDropdown();
        } catch (error) {
          console.error('Error fetching tournaments:', error);
        }
      }

      function populateTournamentDropdown() {
        selectTournamentDropdown.innerHTML =
          '<option value="">-- Select a Tournament --</option>';
        availableTournaments.forEach((tournament) => {
          const option = document.createElement('option');
          option.value = tournament.id;
          option.innerText = `${tournament.name} (${tournament.mode.toUpperCase()})`;
          selectTournamentDropdown.appendChild(option);
        });
      }

      async function updateRegistrationFormForTournament() {
        const selectedTournamentId = selectTournamentDropdown.value;
        const player2Fields = document.getElementById('player2Fields');
        const player3Fields = document.getElementById('player3Fields');
        const player4Fields = document.getElementById('player4Fields');

        player2Fields.classList.add('hidden');
        player3Fields.classList.add('hidden');
        player4Fields.classList.add('hidden');

        document.getElementById('player1Name').required = true;
        document.getElementById('player1UID').required = true;
        document.getElementById('player2Name').required = false;
        document.getElementById('player2UID').required = false;
        document.getElementById('player3Name').required = false;
        document.getElementById('player3UID').required = false;
        document.getElementById('player4Name').required = false;
        document.getElementById('player4UID').required = false;

        availableSeatsDisplay.innerText = 'N/A';
        totalSeatsDisplay.innerText = 'N/A';
        completeRegistrationBtn.disabled = false;
        completeRegistrationBtn.innerText = 'Complete Registration';
        completeRegistrationBtn.classList.remove('bg-gray-500', 'cursor-not-allowed');
        completeRegistrationBtn.classList.add('bg-orange-500', 'hover:bg-orange-600');


        if (selectedTournamentId) {
          const selectedTournament = availableTournaments.find(
            (t) => t.id === selectedTournamentId,
          );
          if (selectedTournament) {
            const registrationsSnapshot = await db.collection('registrations').where('tournamentId', '==', selectedTournamentId).get();
            const registeredCount = registrationsSnapshot.size;
            const totalSeats = selectedTournament.totalSeats || 0;
            const remainingSeats = totalSeats - registeredCount;

            availableSeatsDisplay.innerText = remainingSeats;
            totalSeatsDisplay.innerText = totalSeats;

            if (remainingSeats <= 0) {
                completeRegistrationBtn.disabled = true;
                completeRegistrationBtn.innerText = 'Seats Full!';
                completeRegistrationBtn.classList.remove('bg-orange-500', 'hover:bg-orange-600');
                completeRegistrationBtn.classList.add('bg-gray-500', 'cursor-not-allowed');
                alert('Seats full! You cannot enter this tournament.');
            }

            if (selectedTournament.mode === 'duo') {
              player2Fields.classList.remove('hidden');
              document.getElementById('player2Name').required = true;
              document.getElementById('player2UID').required = true;
            } else if (selectedTournament.mode === 'squads') {
              player2Fields.classList.remove('hidden');
              player3Fields.classList.remove('hidden');
              player4Fields.classList.remove('hidden');
              document.getElementById('player2Name').required = true;
              document.getElementById('player2UID').required = true;
              document.getElementById('player3Name').required = true;
              document.getElementById('player3UID').required = true;
              document.getElementById('player4Name').required = true;
              document.getElementById('player4UID').required = true;
            }
          }
        }
      }

      async function renderAdminUpdates() {
        adminUpdatesDiv.innerHTML = '';
        try {
          const updatesSnapshot = await db
            .collection('updates')
            .orderBy('timestamp', 'desc')
            .get();
          if (updatesSnapshot.empty) {
            adminUpdatesDiv.innerHTML =
              '<p>No updates available yet. Check back soon!</p>';
            return;
          }
          updatesSnapshot.forEach((doc) => {
            const update = doc.data();
            const date = update.timestamp
              ? new Date(update.timestamp.toDate()).toLocaleString()
              : 'N/A';
            const updateElement = document.createElement('div');
            updateElement.classList.add(
              'bg-gray-800',
              'p-4',
              'rounded-md',
              'shadow-lg',
            );
            updateElement.innerHTML = `
                <p class="text-orange-400 font-bold mb-1">Update:</p>
                <p class="text-sm text-gray-400 mb-2">${date}</p>
                <p>${update.content}</p>
            `;
            adminUpdatesDiv.appendChild(updateElement);
          });
        } catch (error) {
          console.error('Error loading admin updates:', error);
          adminUpdatesDiv.innerHTML =
            '<p class="text-red-500">Error loading updates.</p>';
        }
      }

      async function renderUpcomingTournamentUpdates() {
        upcomingTournamentUpdatesDiv.innerHTML = '';
        try {
          const upcomingUpdatesSnapshot = await db
            .collection('upcoming_updates')
            .orderBy('timestamp', 'desc')
            .get();
          if (upcomingUpdatesSnapshot.empty) {
            upcomingTournamentUpdatesDiv.innerHTML =
              '<p>No upcoming tournament updates available yet. Check back soon!</p>';
            return;
          }
          upcomingUpdatesSnapshot.forEach((doc) => {
            const update = doc.data();
            const date = update.timestamp
              ? new Date(update.timestamp.toDate()).toLocaleString()
              : 'N/A';
            const updateElement = document.createElement('div');
            updateElement.classList.add(
              'bg-gray-800',
              'p-4',
              'rounded-md',
              'shadow-lg',
            );
            updateElement.innerHTML = `
                <p class="text-orange-400 font-bold mb-1">Update:</p>
                <p class="text-sm text-gray-400 mb-2">${date}</p>
                <p>${update.content}</p>
            `;
            upcomingTournamentUpdatesDiv.appendChild(updateElement);
          });
        } catch (error) {
          console.error('Error loading upcoming updates:', error);
          upcomingTournamentUpdatesDiv.innerHTML =
            '<p class="text-red-500">Error loading upcoming updates.</p>';
        }
      }

      // --- UI Update Function ---
      function updateUI() {
        if (isLoggedIn) {
          profileIcon.classList.remove('hidden'); // Show profile icon
          loginSignupJoinBtn.classList.add('hidden');
          profileNavLinkMobile.classList.remove('hidden');

          // Show initial, hide generic icon
          profileGenericIcon.classList.add('hidden');
          profileInitial.classList.remove('hidden');

          const initial = currentUser.name
            ? currentUser.name.charAt(0).toUpperCase()
            : currentUser.email
            ? currentUser.email.charAt(0).toUpperCase()
            : '';
          profileInitial.innerText = initial;
          profileAvatarInitial.innerText = initial;

          document.getElementById('profileUserName').innerText =
            currentUser.name || 'User';
          document.getElementById('profileUserEmail').innerText =
            currentUser.email || 'N/A';
          document.getElementById('profileUserMobile').innerText = currentUser.mobile
            ? `Mobile: ${currentUser.mobile}`
            : 'N/A';
          updateRegisteredTournamentsList(); // Call this to update the list

          joinNowBtn.classList.remove('hidden');
          currentWalletBalanceSpan.innerText = `₹${walletBalance.toFixed(2)}`;
          walletSection.querySelector('span').innerText = `₹${walletBalance.toFixed(
            2,
          )}`;
        } else {
          profileIcon.classList.remove('hidden'); // Ensure profile icon is visible
          loginSignupJoinBtn.classList.remove('hidden');
          profileSection.classList.add('hidden');
          viewTournamentSection.classList.add('hidden');
          upcomingTournamentsSection.classList.add('hidden');
          leaderboardSection.classList.add('hidden'); // Hide leaderboard on logout
          profileNavLinkMobile.classList.add('hidden');
          joinNowBtn.classList.remove('hidden');
          currentWalletBalanceSpan.innerText = `₹0.00`;
          walletSection.querySelector('span').innerText = `₹0.00`;

          // Show generic icon, hide initial
          profileGenericIcon.classList.remove('hidden');
          profileInitial.classList.add('hidden');
        }
      }

      // MODIFIED: Function to update the list of registered tournaments
      function updateRegisteredTournamentsList() {
        const list = document.getElementById('registeredTournamentsList');
        list.innerHTML = ''; // Clear existing list items

        if (
          currentUser.registeredTournaments &&
          currentUser.registeredTournaments.length > 0
        ) {
          currentUser.registeredTournaments.forEach((registration) => {
            const li = document.createElement('li');
            const timestampStr =
              registration.timestamp && typeof registration.timestamp.toDate === 'function'
                ? new Date(registration.timestamp.toDate()).toLocaleString()
                : 'N/A';

            li.innerHTML = `
                <strong>Tournament:</strong> ${registration.tournamentName || 'N/A'}<br>
                <strong>Mode:</strong> ${registration.mode.charAt(0).toUpperCase() + registration.mode.slice(1)}<br>
                <strong>Player 1:</strong> ${registration.player1.name} (UID: ${registration.player1.uid})<br>
                ${registration.player2 ? `<strong>Player 2:</strong> ${registration.player2.name} (UID: ${registration.player2.uid})<br>` : ''}
                ${registration.player3 ? `<strong>Player 3:</strong> ${registration.player3.name} (UID: ${registration.player3.uid})<br>` : ''}
                ${registration.player4 ? `<strong>Player 4:</strong> ${registration.player4.name} (UID: ${registration.player4.uid})<br>` : ''}
                <em>Registered on: ${timestampStr}</em>
            `;
            list.appendChild(li);
          });
        } else {
          const li = document.createElement('li');
          li.innerText = 'No tournaments registered yet.';
          list.appendChild(li);
        }
      }

      // --- Modal Functions ---
      function openLoginSignupModal() {
        loginSignupModal.style.display = 'flex';
        showSignupEmailForm(); // Default to email signup
      }

      function closeLoginSignupModal() {
        loginSignupModal.style.display = 'none';
      }

      function showSignupEmailForm() {
        document.getElementById('signupEmailForm').classList.remove('hidden');
        document.getElementById('signupMobileForm').classList.add('hidden');
        document.getElementById('loginForm').classList.add('hidden');
        document.getElementById('loginSignupTitle').innerText = 'Sign Up';
        document.getElementById('loginEmail').required = false;
      }

      function showSignupMobileForm() {
        alert(
          'Firebase Phone Authentication requires additional setup (reCAPTCHA, verification codes). This is a placeholder for demonstration.',
        );
        document.getElementById('signupEmailForm').classList.add('hidden');
        document.getElementById('signupMobileForm').classList.remove('hidden');
        document.getElementById('loginForm').classList.add('hidden');
        document.getElementById('loginSignupTitle').innerText = 'Sign Up';
        document.getElementById('loginEmail').required = false;
      }

      function showLoginForm() {
        document.getElementById('signupEmailForm').classList.add('hidden');
        document.getElementById('signupMobileForm').classList.add('hidden');
        document.getElementById('loginForm').classList.remove('hidden');
        document.getElementById('loginSignupTitle').innerText = 'Login';
        document.getElementById('loginEmail').required = true;
      }

      // --- Firebase Authentication Handlers ---
      document
        .getElementById('signupEmailForm')
        .addEventListener('submit', async function (event) {
          event.preventDefault();
          const name = document.getElementById('signupEmailFFName').value; // Changed ID
          const email = document.getElementById('signupEmail').value;
          const password = document.getElementById('signupPassword').value;

          try {
            const userCredential = await auth.createUserWithEmailAndPassword(
              email,
              password,
            );
            const user = userCredential.user;

            await user.updateProfile({ displayName: name });

            await db.collection('users').doc(user.uid).set({
              name: name,
              email: email,
              walletBalance: 0.0, // Initialize wallet balance for new users
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            });

            alert('Signup successful! You are now logged in.');
            closeLoginSignupModal();
          } catch (error) {
            console.error('Signup error:', error.code, error.message);
            alert(`Signup failed: ${error.message}`);
          }
        });

      document
        .getElementById('signupMobileForm')
        .addEventListener('submit', function (event) {
          event.preventDefault();
          const name = document.getElementById('signupMobileFFName').value; // Changed ID
          const mobile = document.getElementById('signupMobileNumber').value;

          alert(
            `Simulated Mobile Signup for ${name} with ${mobile}. (Not connected to Firebase Phone Auth without more code)`,
          );
          closeLoginSignupModal();
        });

      document
        .getElementById('loginForm')
        .addEventListener('submit', async function (event) {
          event.preventDefault();
          const email = document.getElementById('loginEmail').value;
          const password = document.getElementById('loginPassword').value;

          try {
            await auth.signInWithEmailAndPassword(email, password);
            alert('Login successful!');
            closeLoginSignupModal();
          } catch (error) {
            console.error('Login error:', error.code, error.message);
            alert(`Login failed: ${error.message}`);
          }
        });

      // MODIFIED: Google Sign-in with improved account linking and error handling
      async function googleSignIn() {
        const provider = new firebase.auth.GoogleAuthProvider();
        try {
          const result = await auth.signInWithPopup(provider);
          const user = result.user; // The user object from Google sign-in

          // Check if a user document exists in Firestore, create if not
          const userDocRef = db.collection('users').doc(user.uid);
          const userDoc = await userDocRef.get();

          if (!userDoc.exists) {
            // If user document doesn't exist, create it
            await userDocRef.set({
              name: user.displayName,
              email: user.email,
              walletBalance: 0.0, // Initialize wallet balance for new users
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            });
          } else {
            // If user document exists, update it (e.g., if display name changed)
            await userDocRef.update({
              name: user.displayName,
              email: user.email,
            });
          }

          alert('Google Sign-in successful!');
          closeLoginSignupModal();
        } catch (error) {
          console.error('Google Sign-in error:', error.code, error.message);

          if (error.code === 'auth/account-exists-with-different-credential') {
            const email = error.customData.email;
            const pendingCred = error.credential; // The Google credential

            // Fetch sign-in methods for this email
            try {
              const methods = await auth.fetchSignInMethodsForEmail(email);

              // If the existing account was created with email/password
              if (methods.includes('password')) {
                alert(
                  `An account with this email (${email}) already exists with an Email and Password. To link your Google account, please log in with your Email and Password first.`,
                );
                showLoginForm(); // Show the login form
                document.getElementById('loginEmail').value = email; // Pre-fill email

                // IMPORTANT: For full account linking, after the user logs in with email/password,
                // you would need to provide a UI element (e.g., in their profile) to allow them
                // to link this Google account using `auth.currentUser.linkWithCredential(pendingCred)`.
                // This is a security measure by Firebase.
              } else if (methods.includes('phone')) {
                alert(
                  `An account with this email (${email}) already exists with a Phone Number. Please log in with your phone number first to link your Google account.`,
                );
                // You would show your phone login form here if you have one
              } else {
                // Handle other potential providers if necessary
                alert(
                  `An account with this email (${email}) already exists with a different sign-in method. Please log in with your original method.`,
                );
              }
            } catch (fetchMethodsError) {
              console.error('Error fetching sign-in methods:', fetchMethodsError);
              alert(
                'An error occurred while checking existing accounts. Please try again.',
              );
            }
          } else if (error.code === 'auth/popup-closed-by-user') {
            alert('Google Sign-in popup closed. Please try again.');
          } else {
            alert(`Google Sign-in failed: ${error.message}`);
          }
        }
      }

      async function logoutUser() {
        try {
          await auth.signOut();
          alert('You have been logged out.');
          location.reload();
        } catch (error) {
          console.error('Logout error:', error.code, error.message);
          alert(`Logout failed: ${error.message}`);
        }
      }

      // NEW: Forgot Password Function - Improved error handling and user feedback
      async function forgotPassword() {
        const email = prompt(
          'Please enter your registered email address to reset your password:',
        );
        if (email) {
          try {
            await auth.sendPasswordResetEmail(email);
            alert(
              'Password reset email sent! Please check your inbox (and spam folder).',
            );
          } catch (error) {
            console.error('Forgot password error:', error.code, error.message);
            let errorMessage =
              'Failed to send password reset email. Please try again.';

            switch (error.code) {
              case 'auth/invalid-email':
                errorMessage = 'The email address is not valid.';
                break;
              case 'auth/user-not-found':
                errorMessage = 'No user found with this email address.';
                break;
              case 'auth/too-many-requests':
                errorMessage = 'Too many requests. Please try again later.';
                break;
              default:
                errorMessage = `Failed to send password reset email: ${error.message}`;
            }
            alert(errorMessage);
          }
        }
      }

      // --- Section Visibility Functions ---
      function hideAllMainContentSections() {
        document.getElementById('home').classList.add('hidden');
        document.getElementById('pro-play').classList.add('hidden');
        document.getElementById('rules').classList.add('hidden');
        document.getElementById('contact').classList.add('hidden');
        document.getElementById('profile').classList.add('hidden');
        document.getElementById('view-tournament').classList.add('hidden');
        document.getElementById('upcoming-tournaments').classList.add('hidden');
        document.getElementById('leaderboard').classList.add('hidden'); // NEW

        // Explicitly hide to override any inline styles
        document.getElementById('home').style.display = 'none';
        document.getElementById('pro-play').style.display = 'none';
        document.getElementById('rules').style.display = 'none';
        document.getElementById('contact').style.display = 'none';
        document.getElementById('profile').style.display = 'none';
        document.getElementById('view-tournament').style.display = 'none';
        document.getElementById('upcoming-tournaments').style.display = 'none';
        document.getElementById('leaderboard').style.display = 'none'; // NEW
      }

      function showProfileSection() {
        if (!isLoggedIn) {
          alert('Please login or sign up to view your profile.');
          openLoginSignupModal();
          return;
        }
        hideAllMainContentSections();
        profileSection.classList.remove('hidden');
        profileSection.style.display = 'block'; // Explicitly show
        profileSection.scrollIntoView({ behavior: 'smooth' });
      }

      function hideProfileSection() {
        profileSection.classList.add('hidden');
        profileSection.style.display = 'none'; // Explicitly hide
        // When profile is hidden, decide which sections should be visible by default.
        document.getElementById('home').classList.remove('hidden');
        document.getElementById('home').style.display = 'block';
        document.getElementById('pro-play').classList.remove('hidden');
        document.getElementById('pro-play').style.display = 'block';
        document.getElementById('rules').classList.remove('hidden');
        document.getElementById('rules').style.display = 'block';
        document.getElementById('contact').classList.remove('hidden');
        document.getElementById('contact').style.display = 'block';
        window.location.hash = '#home';
      }

      async function showViewTournamentSection() {
        if (!isLoggedIn) {
          alert('Please login or sign up to view tournament details.');
          openLoginSignupModal();
          return;
        }
        if (!hasRegisteredForTournament) {
          alert('You must register for a tournament to view its details.');
          return;
        }
        hideAllMainContentSections();
        viewTournamentSection.classList.remove('hidden');
        viewTournamentSection.style.display = 'block';
        await renderAdminUpdates(); // Ensure updates are loaded
        await displayRegisteredTournamentDetails(); // Display details of the registered tournament
        viewTournamentSection.scrollIntoView({ behavior: 'smooth' });
      }

      function hideViewTournamentSection() {
        viewTournamentSection.classList.add('hidden');
        viewTournamentSection.style.display = 'none';
        registeredTournamentDetailsDiv.classList.add('hidden'); // Hide tournament details when closing
        // When view tournament is hidden, decide which sections should be visible by default.
        document.getElementById('home').classList.remove('hidden');
        document.getElementById('home').style.display = 'block';
        document.getElementById('pro-play').classList.remove('hidden');
        document.getElementById('pro-play').style.display = 'block';
        document.getElementById('rules').classList.remove('hidden');
        document.getElementById('rules').style.display = 'block';
        document.getElementById('contact').classList.remove('hidden');
        document.getElementById('contact').style.display = 'block';
        window.location.hash = '#home';
      }

      async function displayRegisteredTournamentDetails() {
        if (currentUser.registeredTournaments.length > 0) {
          const registration = currentUser.registeredTournaments[0]; // Assuming one active registration
          const tournamentId = registration.tournamentId;

          if (tournamentId) {
            try {
              const tournamentDoc = await db.collection('tournaments').doc(tournamentId).get();
              if (tournamentDoc.exists) {
                const tournament = tournamentDoc.data();
                displayTournamentName.innerText = tournament.name || 'N/A';
                displayTournamentMode.innerText = tournament.mode ? (tournament.mode.charAt(0).toUpperCase() + tournament.mode.slice(1)) : 'N/A';
                displayTournamentEntryFee.innerText = `₹${(tournament.entryFee || 0).toFixed(2)}`;
                displayTournamentPrizePool.innerText = `₹${(tournament.prizePool || 0).toFixed(2)}`;
                displayTournamentDateTime.innerText = `${tournament.date || 'N/A'} ${tournament.time || 'N/A'}`;
                displayTournamentDescription.innerText = tournament.description || 'No description available.';
                displayRoomId.innerText = tournament.roomId || 'N/A';
                displayRoomPassword.innerText = tournament.password || 'N/A';
                registeredTournamentDetailsDiv.classList.remove('hidden');
              } else {
                registeredTournamentDetailsDiv.classList.add('hidden');
                alert('Registered tournament details not found.');
              }
            } catch (error) {
              console.error('Error fetching registered tournament details:', error);
              registeredTournamentDetailsDiv.classList.add('hidden');
              alert('Error loading registered tournament details.');
            }
          } else {
            registeredTournamentDetailsDiv.classList.add('hidden');
            alert('No tournament ID found for your registration.');
          }
        } else {
          registeredTournamentDetailsDiv.classList.add('hidden');
        }
      }


      function showUpcomingTournamentsSection() {
        hideAllMainContentSections();
        upcomingTournamentsSection.classList.remove('hidden');
        upcomingTournamentsSection.style.display = 'block';
        renderUpcomingTournamentUpdates();
        upcomingTournamentsSection.scrollIntoView({ behavior: 'smooth' });
      }

      function hideUpcomingTournamentsSection() {
        upcomingTournamentsSection.classList.add('hidden');
        upcomingTournamentsSection.style.display = 'none';
        // When upcoming tournaments is hidden, decide which sections should be visible by default.
        document.getElementById('home').classList.remove('hidden');
        document.getElementById('home').style.display = 'block';
        document.getElementById('pro-play').classList.remove('hidden');
        document.getElementById('pro-play').style.display = 'block';
        document.getElementById('rules').classList.remove('hidden');
        document.getElementById('rules').style.display = 'block';
        document.getElementById('contact').classList.remove('hidden');
        document.getElementById('contact').style.display = 'block';
        window.location.hash = '#home';
      }

      function showLeaderboardSection() {
        hideAllMainContentSections();
        leaderboardSection.classList.remove('hidden');
        leaderboardSection.style.display = 'block';
        // You would add logic here to fetch and display leaderboard data
        leaderboardSection.scrollIntoView({ behavior: 'smooth' });
      }

      function hideLeaderboardSection() {
        leaderboardSection.classList.add('hidden');
        leaderboardSection.style.display = 'none';
        document.getElementById('home').classList.remove('hidden');
        document.getElementById('home').style.display = 'block';
        document.getElementById('pro-play').classList.remove('hidden');
        document.getElementById('pro-play').style.display = 'block';
        document.getElementById('rules').classList.remove('hidden');
        document.getElementById('rules').style.display = 'block';
        document.getElementById('contact').classList.remove('hidden');
        document.getElementById('contact').style.display = 'block';
        window.location.hash = '#home';
      }

      // NEW: Functions to show specific sections (Battle Royale, Rules, Contact Us)
      function showBattleRoyaleSection() {
        hideAllMainContentSections(); // Hide all other sections first
        document.getElementById('pro-play').classList.remove('hidden');
        document.getElementById('pro-play').style.display = 'block';
        document.getElementById('pro-play').scrollIntoView({ behavior: 'smooth' });
      }

      function showRulesSection() {
        hideAllMainContentSections(); // Hide all other sections first
        document.getElementById('rules').classList.remove('hidden');
        document.getElementById('rules').style.display = 'block';
        document.getElementById('rules').scrollIntoView({ behavior: 'smooth' });
      }

      function showContactSection() {
        hideAllMainContentSections(); // Hide all other sections first
        document.getElementById('contact').classList.remove('hidden');
        document.getElementById('contact').style.display = 'block';
        document.getElementById('contact').scrollIntoView({ behavior: 'smooth' });
      }

      // MODIFIED: Function to scroll to the home section
      function scrollToHome() {
        hideAllMainContentSections(); // Hide other sections first
        document.getElementById('home').classList.remove('hidden');
        document.getElementById('home').style.display = 'block'; // Ensure it's visible
        document.getElementById('home').scrollIntoView({ behavior: 'smooth' });
      }

      // --- Wallet Functions ---
      function openWalletModal() {
        if (!isLoggedIn) {
          alert('Please login or sign up to access wallet features.');
          openLoginSignupModal();
          return;
        }
        walletModal.style.display = 'flex';
        // Reset wallet modal to initial state
        walletMainContent.classList.remove('hidden');
        paymentMethodSelection.classList.add('hidden');
        depositAmountInput.classList.add('hidden');
        amountPrompt.classList.add('hidden');
        qrCodeSection.classList.add('hidden');
        withdrawalForm.classList.add('hidden'); // Hide withdrawal form initially
        updateUI(); // Update balance display
      }

      function closeWalletModal() {
        walletModal.style.display = 'none';
        // Reset all wallet sub-sections to hidden when closing the modal
        walletMainContent.classList.remove('hidden');
        paymentMethodSelection.classList.add('hidden');
        depositAmountInput.classList.add('hidden');
        amountPrompt.classList.add('hidden');
        qrCodeSection.classList.add('hidden');
        withdrawalForm.classList.add('hidden');
        pendingDepositAmount = 0.0; // Reset pending amount
      }

      function showPaymentMethodSelection() {
        walletMainContent.classList.add('hidden');
        paymentMethodSelection.classList.remove('hidden');
        withdrawalForm.classList.add('hidden'); // Ensure withdrawal form is hidden
      }

      function showDepositAmountInput() {
        paymentMethodSelection.classList.add('hidden');
        depositAmountInput.classList.remove('hidden');
      }

      function showAmountPrompt() {
        depositAmountInput.classList.add('hidden');
        amountPrompt.classList.remove('hidden');
        depositAmountField.value = ''; // Clear previous input
      }

      function processAmount() {
        const amount = parseFloat(depositAmountField.value);
        if (isNaN(amount) || amount <= 0) {
          alert('Please enter a valid amount.');
          return;
        }

        pendingDepositAmount = amount; // Store the amount for later
        amountPrompt.classList.add('hidden');
        qrCodeSection.classList.remove('hidden');
        enteredAmountField.value = pendingDepositAmount; // Pre-fill amount in the next step
        enteredAmountField.readOnly = true; // Make amount read-only in QR section
      }

      function cancelAmountPrompt() {
        amountPrompt.classList.add('hidden');
        depositAmountInput.classList.remove('hidden'); // Go back to previous step
        pendingDepositAmount = 0.0; // Clear pending amount
      }

      async function submitUpiDetails() {
        const upiTransactionId = document.getElementById('upiTransactionId').value;
        const enteredAmount = parseFloat(
          document.getElementById('enteredAmount').value,
        );

        const upiIdRegex = /^[0-9A-Za-z]{12,20}$/;

        if (!upiTransactionId || upiTransactionId.trim() === '') {
          alert('Please enter a valid UPI Transaction ID/UTR/UPI Reference No.');
          return;
        }

        if (!upiIdRegex.test(upiTransactionId)) {
          alert('Invalid UPI Transaction ID format. Please enter a valid 12-20 digit alphanumeric ID.');
          return;
        }

        if (isNaN(enteredAmount) || enteredAmount <= 0) {
          alert('Please enter a valid amount.');
          return;
        }

        if (enteredAmount !== pendingDepositAmount) {
          alert(
            'The entered amount does not match the amount you intended to deposit. Please ensure they are the same.',
          );
          return;
        }

        if (!currentUser.uid) {
          alert('User not logged in. Cannot process payment.');
          return;
        }

        try {
          await db.collection('deposits').add({
            userId: currentUser.uid,
            userName: currentUser.name,
            userEmail: currentUser.email,
            amount: enteredAmount,
            upiTransactionId: upiTransactionId,
            status: 'pending', // 'pending', 'approved', 'rejected'
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          });

          alert(
            `Payment of ₹${enteredAmount.toFixed(
              2,
            )} submitted successfully! Your money will be credited to your wallet within 5 minutes after admin approval.`,
          );
          updateUI();
          closeWalletModal();
        } catch (error) {
          console.error('Error processing UPI payment:', error);
          alert(`Payment failed: ${error.message}. Please try again.`);
        }
      }

      function showWithdrawalForm() {
        walletMainContent.classList.add('hidden');
        paymentMethodSelection.classList.add('hidden');
        depositAmountInput.classList.add('hidden');
        amountPrompt.classList.add('hidden');
        qrCodeSection.classList.add('hidden');
        withdrawalForm.classList.remove('hidden');
        document.getElementById('withdrawName').value = currentUser.name || ''; // Pre-fill name
        document.getElementById('withdrawUpiId').value = ''; // Clear UPI ID
        document.getElementById('withdrawAmount').value = ''; // Clear amount
      }

      async function processWithdrawal() {
        const name = document.getElementById('withdrawName').value;
        const upiId = document.getElementById('withdrawUpiId').value;
        const amount = parseFloat(document.getElementById('withdrawAmount').value);
        const MIN_WITHDRAWAL = 5.0;

        if (!name || !upiId || isNaN(amount) || amount <= 0) {
          alert('Please fill in all withdrawal details correctly.');
          return;
        }

        if (amount < MIN_WITHDRAWAL) {
          alert(`MINIMUM WITHDRAW RS ${MIN_WITHDRAWAL.toFixed(2)}`);
          return;
        }

        if (walletBalance === 0) {
          alert("You don't have enough balance to withdraw amount.");
          return;
        }

        if (amount > walletBalance) {
          alert(
            `You can only withdraw up to your current balance: ₹${walletBalance.toFixed(
              2,
            )}`,
          );
          return;
        }

        if (!currentUser.uid) {
          alert('User not logged in. Cannot process withdrawal.');
          return;
        }

        try {
          await db.collection('withdrawals').add({
            userId: currentUser.uid,
            userName: currentUser.name,
            userEmail: currentUser.email,
            upiId: upiId,
            amount: amount,
            status: 'pending', // 'pending', 'approved', 'rejected'
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          });

          walletBalance -= amount;
          updateUI(); // Update balance display

          alert(
            'Withdrawal request submitted successfully! Your money will be credited to your account within 5 minutes after admin approval.',
          );
          closeWalletModal();
        } catch (error) {
          console.error('Error processing withdrawal:', error);
          alert(`Withdrawal failed: ${error.message}. Please try again.`);
        }
      }

      // --- Registration Functions ---
      async function checkLoginAndOpenRegisterModal() {
        console.log('checkLoginAndOpenRegisterModal called');
        if (isLoggedIn) {
          console.log('User is logged in, opening register modal.');
          await fetchAvailableTournaments(); // Fetch tournaments before opening
          registerModal.style.display = 'flex';
          updateRegistrationFormForTournament(); // Initialize form state
        } else {
          console.log('User not logged in, opening login/signup modal.');
          alert('Please Login or Sign Up first to join the tournament.');
          openLoginSignupModal();
        }
      }

      function closeRegisterModal() {
        registerModal.style.display = 'none';
        document.getElementById('registrationForm').reset(); // Clear form
        // Reset player fields visibility
        document.getElementById('player2Fields').classList.add('hidden');
        document.getElementById('player3Fields').classList.add('hidden');
        document.getElementById('player4Fields').classList.add('hidden');
      }

      window.onclick = function (event) {
        if (event.target == loginSignupModal) {
          loginSignupModal.style.display = 'none';
        }
        if (event.target == registerModal) {
          closeRegisterModal(); // Use the dedicated close function
        }
        if (event.target == walletModal) {
          if (!event.target.closest('.modal-content')) {
            closeWalletModal();
          }
        }
        if (
          event.target == mobileNavOverlay &&
          mobileNavOverlay.classList.contains('active')
        ) {
          toggleMobileMenu();
        }
      };

      document
        .getElementById('registrationForm')
        .addEventListener('submit', async function (event) {
          event.preventDefault();

          const selectedTournamentId = document.getElementById('selectTournament').value;
          if (!selectedTournamentId) {
              alert('Please select a tournament.');
              return;
          }

          const selectedTournament = availableTournaments.find(t => t.id === selectedTournamentId);
          if (!selectedTournament) {
              alert('Selected tournament not found.');
              return;
          }

          const registrationsSnapshot = await db.collection('registrations').where('tournamentId', '==', selectedTournamentId).get();
          const registeredCount = registrationsSnapshot.size;
          const totalSeats = selectedTournament.totalSeats || 0;
          const remainingSeats = totalSeats - registeredCount;

          if (remainingSeats <= 0) {
              alert('Seats full! You cannot enter this tournament.');
              return;
          }

          const player1Name = document.getElementById('player1Name').value;
          const player1UID = document.getElementById('player1UID').value;

          if (!currentUser.uid) {
            alert('User not logged in. Please log in to register.');
            return;
          }

          let registrationData = {
            tournamentId: selectedTournamentId,
            tournamentName: selectedTournament.name,
            mode: selectedTournament.mode,
            player1: {
              name: player1Name,
              uid: player1UID,
            },
            userId: currentUser.uid,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          };

          if (selectedTournament.mode === 'duo' || selectedTournament.mode === 'squads') {
            const player2Name = document.getElementById('player2Name').value;
            const player2UID = document.getElementById('player2UID').value;
            if (!player2Name || !player2UID) { alert('Please fill Player 2 details.'); return; }
            registrationData.player2 = { name: player2Name, uid: player2UID };
          }
          if (selectedTournament.mode === 'squads') {
            const player3Name = document.getElementById('player3Name').value;
            const player3UID = document.getElementById('player3UID').value;
            const player4Name = document.getElementById('player4Name').value;
            const player4UID = document.getElementById('player4UID').value;
            if (!player3Name || !player3UID || !player4Name || !player4UID) { alert('Please fill Player 3 and Player 4 details.'); return; }
            registrationData.player3 = { name: player3Name, uid: player3UID };
            registrationData.player4 = { name: player4Name, uid: player4UID };
          }

          try {
            // Check if user is already registered for this specific tournament
            const existingRegistration = await db.collection('registrations')
                .where('userId', '==', currentUser.uid)
                .where('tournamentId', '==', selectedTournamentId)
                .get();

            if (!existingRegistration.empty) {
                alert('You are already registered for this tournament!');
                return;
            }

            await db.collection('registrations').add(registrationData); // Use .add() for new document with auto-generated ID

            // Update currentUser object with the new registration
            // Re-fetch user data to ensure `currentUser.registeredTournaments` is up-to-date
            const updatedRegistrationSnapshot = await db
              .collection('registrations')
              .where('userId', '==', currentUser.uid)
              .get();
            currentUser.registeredTournaments = [];
            if (!updatedRegistrationSnapshot.empty) {
              updatedRegistrationSnapshot.forEach((doc) => {
                currentUser.registeredTournaments.push({
                  id: doc.id,
                  ...doc.data(),
                });
              });
              hasRegisteredForTournament = true;
            } else {
              hasRegisteredForTournament = false;
            }

            console.log('Registration Data:', registrationData);
            alert('Registration successful!');
            closeRegisterModal();
            updateUI(); // This will call updateRegisteredTournamentsList again with fresh data
          } catch (error) {
            console.error('Error registering for tournament:', error);
            alert(`Registration failed: ${error.message}`);
          }
        });

      function toggleMobileMenu() {
        mobileNavOverlay.classList.toggle('active');
      }

      document.addEventListener('DOMContentLoaded', () => {
        renderAdminUpdates();
        renderUpcomingTournamentUpdates();
        fetchAvailableTournaments(); // Fetch tournaments on page load
        updateUI(); // Call updateUI on DOMContentLoaded to set initial visibility
      });

      // NEW: Function to check login status before showing upcoming tournaments
      function checkLoginAndShowUpcomingTournaments() {
        if (isLoggedIn) {
          showUpcomingTournamentsSection();
        } else {
          alert('Please login or sign up to view upcoming tournaments.');
          openLoginSignupModal();
        }
      }
    </script>

    <script>
      async function checkRegistrationThenShowTournament() {
        const user = firebase.auth().currentUser;
        const db = firebase.firestore();

        if (!user) {
          alert('Please login first.');
          openLoginSignupModal();
          return;
        }

        try {
          const registrationSnapshot = await db
            .collection('registrations')
            .where('userId', '==', user.uid)
            .get();

          if (!registrationSnapshot.empty) {
            hasRegisteredForTournament = true;
            showViewTournamentSection();
          } else {
            alert('Please complete registration before viewing the tournament.');
            checkLoginAndOpenRegisterModal();
          }
        } catch (error) {
          console.error('Error checking registration:', error);
          alert('An error occurred while checking your registration status.');
        }
      }
    </script>
  </body>
</html>
